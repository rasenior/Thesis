
```{r knitr-setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = FALSE,message = FALSE,error = FALSE, warning = FALSE, 
                      fig.width = 16.6/2.54, fig.height = 10/2.54, dpi = 800, 
                      fig.path = "./output/", fig.align = "centre")
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
```

```{r setup-other, include=FALSE}
library(ThermStats)
library(ggplot2)
library(dplyr)
library(cowplot)
library(viridis)
source("scripts/tidy_hour.R")
# Significance val
get_signif <- function(p_val){
    signif_level <- 
        ifelse(p_val >0.05, paste("= ", signif(p_val, 3), sep = ""),
               ifelse(p_val <= 0.05 & p_val >0.01, "< 0.05",
                      ifelse(p_val <= 0.01 & p_val >0.001, "< 0.01", 
                             "< 0.001")))
    return(signif_level)
}

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442",
               "#0072B2", "#D55E00", "#CC79A7")

title_size<-8
text_size<-6
lab_size <- 6
```

```{r load-data, include = FALSE}
load("data/ch3/models/flir.Rdata")
load("data/ch3/models/worldclim.Rdata")
flir_example <- readRDS("data/ch3/flir_patch_example.Rds")
worldclim_patches <- readRDS("data/ch3/all_stats.Rds")
worldclim_bg <- readRDS("data/ch3/borneo_outline.Rds")
```

```{r prep-results}
RVs <- c("median", "SHDI", "upr_range", "lwr_range",
         "hot_area", "cold_area", "hot_density", "cold_density",
         "hot_shape_index", "cold_shape_index",
         "hot_aggregation", "cold_aggregation")
flir_results_sum <-
    filter(flir_results_sum,
           !(is.na(p_val))) %>% 
    mutate(RV = factor(RV,
                       levels = RVs),
           p_val = get_signif(p_val)) %>% 
    arrange(RV) %>% 
    mutate(fig_ref = paste("\\autoref{fig:fig-3-2}", 
                           rep(letters[1:12], each = 2), 
                           sep = ""),
           ref = paste(test, " = ", signif(test_val,3), ", ",
                       "P ", p_val, 
                       "; ", fig_ref,
                       sep = ""))
worldclim_results_sum <-
    filter(worldclim_results_sum,
           !(is.na(p_val))) %>% 
    mutate(RV = factor(RV,
                       levels = RVs), 
           p_val = get_signif(p_val)) %>% 
    arrange(RV) %>% 
    mutate(fig_ref = paste("\\autoref{fig:fig-3-3}", 
                           letters[1:8], 
                           sep = ""),
           ref = paste(test, " = ", signif(test_val,3), ", ",
                       "P ", p_val, 
                       "; ", fig_ref,
                       sep = ""))
```

```{r prep-4-plotting, include = FALSE}
flir_stars <-
    filter(.data = flir_results_sum, 
           dropped_EV == "s(day_mins, bs = 'cs', k = 5)") %>%
    dplyr::select(sig)
worldclim_stars <-
    dplyr::select(worldclim_results_sum, sig)
```

# A framework for quantifying fine-scale thermal heterogeneity using thermography {#ch3}

\begin{figure}[!htb]
\centering
\includegraphics[width=15cm]{pics/Thermal-image1.png}
\caption*{Thermal image of rainforest floor.}
\end{figure}

This chapter is currently in preparation for submission to *Ecography* as:

**Senior RA, Hill JK, Edwards DP. A framework for quantifying fine-scale thermal heterogeneity using thermography.**

\pagebreak

## Abstract

Variation in temperature at a fine spatial scale creates critically important microclimates for many organisms. Quantifying thermal heterogeneity at this scale is challenging and, until recently, has been largely restricted to the use of dataloggers to record air temperature. Thermography is becoming an increasingly viable alternative. A single thermal photo contains thousands of spatially explicit surface temperature measurements, making them ideal for rapidly assessing temperature variation at fine scale. To date, the technology and data have been underexploited in terrestrial ecology, partly because there is limited technical support. Here, we present a framework and `R` package for processing thermal images and other gridded temperature data, demonstrated using thermal images from selectively logged and unlogged forests of Borneo. We quantified heterogeneity in the understorey using metrics that capture both the frequency distribution and spatial distribution of temperature. Thermal heterogeneity was similar in logged and unlogged forests, but showed clear patterns over the day. When average temperature reached its maximum -- around noon -- we observed peaks in thermal diversity, the deviation of temperature extremes from the average, and in the area of statistically-defined 'hot spots'. At the same time, 'cold spots' were more irregularly shaped and less spatially clustered, which could make them easier for organisms to locate when they are most necessary (i.e. when average temperatures are highest). To illustrate how our approach can be applied to other temperature data we used mean monthly temperature for Borneo from WorldClim2 (~1 km^2^ resolution). Thermal diversity and spatial clustering of cold spots were highest in September and October, which could be related to the transition from dry to rainy season. Put together, our framework simplifies the processing of thermal data, and our metrics capture key spatiotemporal temperature trends that could underpin species? responses to environmental change.

## Introduction

A key way in which organisms will respond to future climate change is adaptation *in situ* [@hannah_fine-grain_2014]. On a daily basis, mobile organisms respond to extremes of heat by exploiting fine-scale (mm to m) thermal heterogeneity [@scheffers_microhabitats_2014; @gonzalez_del_pliego_thermally_2016]. Over longer time periods, climate at this scale ('microclimates') can also maximise fitness and thus influence the fine-scale distribution of less mobile species [@maclean_fine-scale_2017]. The same mechanisms could temper species' exposure to global climate change [@suggitt_extinction_2018; @scheffers_microhabitats_2014], particularly in structurally complex habitats like tropical rainforests [@scheffers_extreme_2017]. To accurately predict species' responses to climate warming in these places we must therefore be able to efficiently and effectively capture thermal heterogeneity at fine scale.  

The use of temperature dataloggers has been instrumental in advancing our knowledge of temperature at biologically relevant spatial scales [@bramer_advances_2018]. However, dataloggers can only record the air temperature in their immediate vicinity, and so must be highly replicated in space and in a variety of microhabitats to capture spatial temperature variation. Additionally, the vast majority of terrestrial organisms are very small, flat, or thigmothermic (i.e. thermoregulate via direct contact with a surface), hence surface temperature is often more biologically relevant than is air temperature [e.g. @kaspari_thermal_2015]. 

Technological advances in recent years have made thermal cameras an increasingly affordable and practical complement to dataloggers [@scheffers_extreme_2017; @faye_toolbox_2016]. A single thermal image provides thousands of spatially explicit surface temperature measurements at the mm-cm scale. With such a wealth of data and limited guidance on how to process and analyse it, both the technology itself and the data provided have not been utilised to their full potential within terrestrial ecology. @faye_toolbox_2016 provide an excellent starting point from which to formulate a framework. Using visual images (red, green and blue spectral bands) in combination with thermal images, collected using an unmanned aerial vehicle (UAV), Faye et al. demonstrate how thermography can be used to compare thermal heterogeneity between different surfaces (in this case, bare soil versus crop surface), and suggest various metrics to capture different facets of thermal heterogeneity. However, while the use of UAVs in complex habitats is indeed becoming more feasible [@sanchez-azofeifa_twenty-first_2017], for the foreseeable future it is likely that thermography in these places will most commonly consist of thermal photos collected manually in the field, and there is no comparable toolbox for these data.

Both @faye_toolbox_2016 and @scheffers_extreme_2017 provide introductory `R` scripts to facilitate the processing of thermal photos. However, batch processing of data from thermal images is rarely straightforward, while parameters such as emissivity strongly influence the accuracy of measurements but may not be well understood by the novice user [@bramer_advances_2018].The development of the `Thermimage` package [@tattersall_thermimage:_2017] in `R` has considerably eased extraction and conversion of raw data from FLIR thermal cameras specifically, but this package does not directly facilitate processing in batch nor does it calculate (or suggest) what metrics are most appropriate to quantify thermal heterogeneity using thermal images. 

The most appropriate metrics to capture thermal heterogeneity will depend on the taxonomic group and research questions of interest. Temperature varies across time and space in a multitude of ways that can easily be captured by thermal images; it is important to exploit the information provided without becoming overwhelmed. Both @shi_framework_2016 and @faye_toolbox_2016 provide a useful summary of some important metrics, and Faye et al. notably introduce a spatial component by borrowing metrics from landscape ecology, such as Shape Index and Cohesion Index [@fragstats_2012]. Extending this approach reveals other techniques that could be useful in this context, such as hot spot analysis [@getis_local_1996].

In this study, we introduce an `R` package -- `ThermStats` -- which combines ideas, techniques and metrics from previous work into one simple framework for quantifying heterogeneity in thermal images. Using images collected in primary and selectively logged forests on Borneo, we illustrate the utility of our package for comparing thermal heterogeneity over time and between forest types. In addition, while the package was designed with fine-scale data in mind, we use temperature data for Borneo at 1 km^2^ resolution from the WorldClim2 database [@fick_worldclim_2017] to demonstrate how our metrics of thermal heterogeneity can also be calculated for other kinds of gridded temperature data.

## Methods {#ch3-methods}

### Step 1: Data collection {#ch3-step1}

High resolution surface temperature measurements can easily be collected in the field using a handheld thermal camera. We used a FLIR Systems, model E40 camera, which costs ~US$4,000, weighs 825 g, and takes 19,200 measurements (160 x 120 pixels) in a single photo  [@flir_manual_2016; @scheffers_extreme_2017]. Various other models are available, including the smaller and more affordable FLIR ONE smartphone attachment at ~US$300, 34.5 g and a resolution of 80 x 60 pixels. As with any field study, the sampling design should aim to achieve sufficient coverage over the study area and over time, such that the images are representative samples of the treatments of interest.  For example, a single image of the ground from 1 m away encompasses an area of 0.9 x 1.1 m using a FLIR E40 camera [@flir_manual_2016], and so it may be necessary to take multiple photos in different cardinal directions and at different times of day to effectively represent the temperature of a study plot [[Chapter 4](#ch4); @scheffers_extreme_2017].  

Before any data are collected, we recommend users familiarise themselves with the technology. There are various sources of the infrared radiation detected by a thermal camera, but we want to focus only on the radiation emitted by the object of interest, which is a function of its temperature. The amount of radiation emitted by a particular object, for a given temperature, depends on its emissivity. A perfect blackbody has an emissivity of 1, while surfaces that an ecologist is likely to photograph typically have an emissivity ranging from 0.92 [for dry, bare soil; @flir_manual_2016] to 0.99 [for green broadleaf forest; @snyder_classification-based_1998].  Additionally, the temperature and relative humidity of the atmosphere and the distance between the object and the camera will all affect (1) the amount of emitted radiation that is absorbed by the atmosphere and (2) the amount of radiation that originates from the atmosphere itself, with some of this also being reflected by the object (reflected apparent temperature). 

To accurately quantify surface temperature, environmental parameters (emissivity, reflected apparent temperature, atmospheric temperature, atmospheric relative humidity and object distance) can be set in the camera or defined during data processing (see ['Step 3: Conversion of raw data'](#ch3-step3)). The benefit of the latter approach is that the user can measure atmospheric temperature and relative humidity concurrently with thermal image collection, and these parameters can then be set for each image individually. Object distance should be minimised, and it is usually advisable to keep this value constant. Emissivity can either be estimated from the literature [cf. @scheffers_extreme_2017] or sampled in the field [@flir_manual_2016]. Reflected apparent temperature can also be sampled [@flir_manual_2016], although for high emissivities and short object distances, relatively little radiation is reflected and thus apparent temperature can be assumed to equal the atmospheric temperature [@tattersall_thermimage:_2017]. It is recommended that thermal cameras are regularly calibrated (FLIR Systems suggest doing so once per year).

### Step 2: Data extraction

A single thermal photo from a model E40 camera comprises 160 x 120 pixels, each of which is a unique measurement of received infrared radiation encoded as a raw 16-bit value. Data can be extracted into a .csv file using the freely available FLIR Tools software [https://www.flir.com/products/flir-tools; cf. @scheffers_extreme_2017], but we do not recommend this because it cannot be done in batch, there is less transparency regarding the conversion of raw values to temperature, and FLIR Tools uses interpolation to elevate the number of pixels (up to 320 x 240 for a model E40 camera). A quicker and more flexible approach is to use the `R` package `Thermimage` [@tattersall_thermimage:_2017]. The function `readflirJPG` is able to extract all raw data from a FLIR thermal image, and can be implemented in batch using the function `batch_extract` in our package, `ThermStats`.

### Step 3: Conversion of raw data {#ch3-step3}

The raw values embedded in a FLIR thermal image can be converted to temperature in &deg;C using equations from infrared thermography [@tattersall_thermimage:_2017; @flir_manual_2016]. This is made simple by the function `raw2temp` in the `Thermimage` package, which can be implemented in batch in our package using the function `batch_convert`. Several default values are defined in `raw2temp`, but the most accurate temperature conversion will be achieved when the environmental parameters, described in ['Step 1'](#ch3-step1), are defined by the user. Notably, default emissivity is 1, but should realistically take a value between 0.95 and 0.97 [@tattersall_thermimage:_2017], while the default relative humidity of 50% is excessively low for moist habitats like tropical rainforest. Conversion of raw data also requires various calibration constants that are specific to each camera. These can be retrieved from a thermal image using the `Thermimage` function `flirsettings`, which is done automatically within our `batch_extract` function.

### Step 4: Calculate metrics of thermal hetereogeneity

The most relevant metrics to quantify thermal heterogeneity depend on the particular research questions. The function `get_stats` takes a single thermal dataset, in the form of a matrix or raster, and calculates user-defined summary statistics across all pixels. Standard summary statistics could include measures such as mean and standard deviation, but may also include metrics like thermal richness (the number of unique temperature values) and thermal diversity indices [cf. @faye_toolbox_2016]. Several helper functions are available to implement less standard summary statistics. Based on discussions in @faye_toolbox_2016 and @shi_framework_2016, we recommend some suitable statistics in \autoref{tab:tab-3-1}.

The function `get_stats` identifies hot and cold spots in thermal images using a standalone function `get_patches`. Hot and cold spots are based on the Getis-Ord local statistic [@getis_local_1996], calculated using the `spdep` package [@bivand_comparing_2015]. The statistic is calculated for individual pixels by comparing its value to that of neighbouring pixels. The size of the neighbourhood and style of spatial weighting are specified by the user (these arguments are passed directly to the relevant functions in the `spdep` package). High positive values exceeding the Z-value threshold [defined according to the sample size; @getis_local_1996] are classified as hot spots, and low negative values as cold spots. Several spatial statistics are then calculated to characterise the hot and cold spots [\autoref{tab:tab-3-2}; cf. @faye_toolbox_2016]. There is an option to return patch outlines as a `SpatialPolygonsDataFrame`, which can be plotted on the temperature data using `plot_patches` alongside an (optional) histogram of the temperature distribution (\autoref{fig:fig-3-1}).

```{r tab-3-1}
```

\begin{table}[!htb]
\begin{center}
\renewcommand{\arraystretch}{1.5} % reduce space between rows
\setlength{\tabcolsep}{5pt} % reduce space between columns
\begin{tabular}{p{2.5cm}p{11cm}}
\toprule 
\bfseries Summary statistic & \bfseries Description \\ \midrule
Average temperature       & Provides context for all other statistics, and could be 
used as a measure of the macroclimate for small, 
surface-dwelling organisms. The median is more robust 
than the mean to spurious extreme values that can 
sometimes arise in thermal images.\\
Temperature extremes      & While more rarely encountered, extreme values can be 
more significant to organisms, for example by exceeding 
upper thermal limits or by providing cool refugia from 
average conditions. The difference between extremes 
provides a measure of thermal diversity/stability 
\citep{shi_framework_2016}, while the difference between
extremes and average temperature provides a measure of 
the potential for thermal buffering. Again, we suggest 
the 5\textsuperscript{th} and 95\textsuperscript{th} 
percentiles are more robust to spurious extreme values 
than the minimum and maximum (respectively).\\
Temperature variability   & Over space and time, the standard deviation or 
coefficient of variation of temperature represents 
another measure of thermal stability 
\citep{shi_framework_2016}, which may be particularly 
significant for organisms requiring constant 
temperatures, e.g. juveniles with a lower capacity for 
thermoregulatory behaviours. In contrast, for other 
mobile organisms -- particularly ectotherms -- high 
thermal diversity is likely to maximise opportunities 
for thermoregulation.\\
Thermal diversity indices & Captures both the richness and evenness of different 
temperatures. Similar to temperature variability, 
the biological relevance of this measure is through 
its influence on the necessity and potential for 
thermoregulation. As discussed by 
\citet{faye_toolbox_2016}, Shannon's thermal 
diversity index quantifies how reliably one can 
predict the temperature of a pixel sampled at random 
from the temperature data. Simpson's thermal diversity 
index is similar, but instead captures the likelihood 
of two pixels being the same temperature (or 
temperature class) when taken at random from the 
thermal landscape.\\
\bottomrule
\end{tabular}
\end{center}
\caption{(\#tab:tab-3-1) Suggested summary statistics that can be applied by \textmyfont{get\_stats}.}
\end{table}

```{r tab-3-2}
```

\begin{sidewaystable}
\begin{center}
\renewcommand{\arraystretch}{1.5} % reduce space between rows
\setlength{\tabcolsep}{6.5pt} % reduce space between columns
\begin{tabular}{ lp{6cm}p{12cm}}
\toprule
\bfseries Patch statistic & \bfseries Description & \bfseries Biological relevance \\ 
\midrule
Area (absolute)      & Total number of pixels            & Larger or more numerous microclimates 
increase opportunities for 
thermoregulation. \\
Area (proportion)    & Proportion of all pixels which 
are inside hot/cold spots         & Where a greater proportion of pixels 
fall inside microclimates there is 
likely to be higher thermal diversity. \\
Abundance            & Number of distinct hot/cold spots & More numerous microclimates increase 
opportunities for thermoregulation. \\
Density              & Number of hot/cold spots per unit
area                              & Larger microclimates increase 
opportunities for thermoregulation. \\
Shape Index          & Irregularity in shape of hot/cold 
spots, with 1 being perfectly 
regular i.e. a square 
\citep{fragstats_2012}            & More irregular microclimates may be 
less thermally stable but easier to 
locate, because of the greater 
proportion of edge. \\
Aggregation Index    & Degree of clustering in space of 
hot/cold spots, with zero 
representing no clustering 
\citep{he_aggregation_2000}       & Dispersed, non-clustered microclimates 
are easier for animals to locate 
\citep{sears_configuration_2016}. \\
Patch Cohesion Index & Physical connectedness of 
hot/cold spots 
\citep{schumaker_using_1996}      & More connected microclimates may 
facilitate more efficient travel. \\
\bottomrule
\end{tabular}
\end{center}
\caption{(\#tab:tab-3-2) Patch statistics calculated for hot and cold spots by the function \textmyfont{get\_stats}.}
\end{sidewaystable}

We assume that for most users the spatial unit of replication will comprise multiple thermal images. In this case, the user can specify a grouping variable in `stats_by_group`. Matrices from each group will be bound together and `get_stats` applied over the combined matrix. We assume the images are not adjacent in space, and therefore pad matrices with NA values before binding. \autoref{tab:tab-D-2} gives an example of the output from `stats_by_group`.

(ref:cap-3-1) Examples of temperature distribution (left column) and thermal images (right column) for temperature data collected at fine and coarse spatial scales (top and bottom rows, respectively). Pixels are shaded from cold (purple) to hot (yellow). Hot spots (outlined in pink) and cold spots (outlined in blue) were identified using the Getis-Ord local statistic of each pixel.

```{r fig-3-1, fig.cap= "(ref:cap-3-1)", fig.width = 16.6/2.54, fig.height=20/2.54, fig.align='center'}
p1a <-
    plot_patches(flir_example$df, flir_example$patches,
                 val_pal = viridis::viridis(10, option = "A"), 
                 print_plot = FALSE, return_plot = TRUE, 
                 lab_size = title_size, text_size = text_size, outline_size = 0.3)
p1b <-
    plot_patches(worldclim_patches$January$df, 
                 worldclim_patches$January$patches,
                 bg_poly = worldclim_bg,
                 bg_colour = "grey",
                 fill_breaks = seq(0, 30, 5),
                 val_pal = viridis(10, option = "A"),
                 print_plot = FALSE, return_plot = TRUE,
                 lab_size = title_size, text_size = text_size, outline_size = 0.3)
p1 <-
    plot_grid(p1a$fig_distribution, p1a$fig_patches, 
              p1b$fig_distribution, p1b$fig_patches, 
              ncol = 2, 
              labels = c("(a)", "(b)", "(c)","(d)"), 
              label_size = lab_size, 
              label_y = 0.1)

p1
```

#### Case studies

We demonstrate our framework and `R` package using fine-scale data collected in the field with a FLIR thermal camera. To investigate how thermal heterogeneity varies over time and with selective logging, we sampled surface temperature in a large area of contiguous forest in Malaysian Borneo in the years 2014 and 2015, using a FLIR Systems model E40 thermal camera. In both years, photos were taken at the centre of plots spaced along existing transects, with six transects in undisturbed primary forest (Danum Valley Conservation Area; 4&deg;57045.2"N, 117&deg;48010.4"E), and six transects in adjacent forest that had been commercially selectively logged twice between 1987 and 2007 (Ulu Segama-Malua Forest Reserve, 4&deg;57042.8"N, 117&deg;56051.7"E). Plots were sampled repeatedly from the coolest to the hottest part of the day (05:00-14:30 h). In each sampling event, thermal images were taken at the centre of the plot in four orthogonal directions, with the camera held at breast height and pointing 45&deg; downwards (relative to the ground). A single pixel represents roughly `r signif((99 * 110) / 19200, 2)` cm^2^. In total we collected 2,972 photos across 144 plots. For full details see @scheffers_extreme_2017 and [Chapter 4](#ch4).

For all analyses, each metric of thermal heterogeneity was calculated across all four photos taken each time a plot was sampled. We focused on the following summary statistics from \autoref{tab:tab-3-1}: median temperature; Shannon Diversity Index; upper temperature range (95^th^ percentile - median); and lower temperature range (median - 5^th^ percentile). We identified hot and cold spots using a neighbourhood size of eight pixels (k = 8 in `spdep::localG`), with row standardised neighbour weights (style = "W" in `spdep::nb2listw`). For hot and cold spots separately, we calculated the following spatial statistics (\autoref{tab:tab-3-2}): average area per patch (total area divided by number of patches, to correct for plots with missing photos); average number of patches per unit area (density); Shape Index; and Aggregation Index. Overall we expected forests to be more thermally homogenous early in the day and to increase in heterogeneity towards the hottest part of the day, around noon, as microclimates increasingly deviate from the average temperature. Loss of vegetation, such as through logging, tends to decrease absorption and reflection of incident radiation and reduce heat loss through evapotranspiration [@oke_boundary_1987; @sears_world_2011], so we might expect logged forests to be more thermally homogenous than unlogged forests. However, there is also evidence that after selective logging there is rapid horizontal growth in the canopy [@asner_canopy_2004], corresponding to rapid thermal recovery ([Chapter 4](#ch4)).

We used Generalized Additive Mixed Effects Models (GAMMs) to model the various thermal heterogeneity metrics against forest type (categorical: primary or logged) and time of day, smoothed with a cubic regression spline. All models were fit using the `gamm4` package [@gamm4_2017] in `R` [version 3.5.0; @r_core_team_2018]. We included a random intercept term for 'year', and for 'plot' nested in 'transect' to account for spatial pseudoreplication. All metrics were modelled with a Gaussian error distribution, except for Aggregation Index which is proportion data [number of edges shared by pixels of the same class divided by the maximum number that could be shared; @he_aggregation_2000], and was therefore modelled using a binomial error distribution. Statistical significance was inspected using likelihood ratio tests, dropping each fixed effect in turn and comparing it to the full model [@zuur_mixed_2009]. 

Although our framework was designed with fine spatial scales in mind, thermal heterogeneity metrics can be calculated for any gridded temperature data. We therefore include an additional assessment of thermal heterogeneity across Borneo, using average monthly temperature (hereafter: temperature) for 1970-2000 from WorldClim2 [@fick_worldclim_2017] at 30 arc-second resolution (approximately 1 km^2^ at the equator).  We calculated the same heterogeneity metrics as in the field study, but focused only on cold spots (because there were very few hot spots). Seasonality is limited on Borneo so we expected that thermal heterogeneity would not change markedly over the year, but may be higher in the dry season -- roughly July to October [@mcalpine_forest_2018] -- when average temperatures are higher and there is less buffering by high water availability. We modelled these metrics against month using Generalized Additive Models (GAMs), smoothed with a cubic regression spline, using the `mgcv` package in `R` [@wood_generalized_2017]. As with the field study, a Gaussian error distribution was used for all but the Aggregation Index, which used a binomial error distribution. Model inference was based on a likelihood ratio test of the full model compared to a model without the fixed effect of month.

## Results

### Field study

All measures of thermal heterogeneity were comparable between primary and unlogged forest (P > 0.05; \autoref{fig:fig-3-2}), but showed clear patterns over the day. Median temperature was lowest around dawn (~06:00 hr) and increased steeply thereafter until reaching a plateau around noon (`r filter(flir_results_sum, RV == "median" & grepl("s[(]day_mins", dropped_EV))$ref`). The thermal Shannon Diversity Index showed a similar pattern, reaching maximum diversity at noon (`r filter(flir_results_sum, RV == "SHDI" & grepl("s[(]day_mins", dropped_EV))$ref`). Although less pronounced, noon peaks were also observed for the upper temperature range (95^th^ percentile minus median; `r filter(flir_results_sum, RV == "upr_range" & grepl("s[(]day_mins", dropped_EV))$ref`) and lower temperature range (median minus 5^th^ percentile; `r filter(flir_results_sum, RV == "lwr_range" & grepl("s[(]day_mins", dropped_EV))$ref`). Together these measures suggest that overall variation in temperature and the deviation of extreme values from the average all increase from dawn to noon.

The spatial distribution of hot and cold spots is less intuitive, but did also vary temporally. For hot spots, the average area peaked around noon (`r filter(flir_results_sum, RV == "hot_area" & grepl("s[(]day_mins", dropped_EV))$ref`) when their density (`r filter(flir_results_sum, RV == "hot_density" & grepl("s[(]day_mins", dropped_EV))$ref`), and Shape Index (`r filter(flir_results_sum, RV == "hot_shape_index" & grepl("s[(]day_mins", dropped_EV))$ref`) were near their minimum values. The Aggregation Index of hot spots reached its lowest value after dawn and increased thereafter (`r filter(flir_results_sum, RV == "hot_aggregation" & grepl("s[(]day_mins", dropped_EV))$ref`). Thus, throughout the morning hot spots became larger but fewer in number, with a more irregular shape and increased spatial clustering. 

Cold spot distribution showed slightly different patterns in the timing of peaks and troughs, compared to hot spots. The average area of cold spots was highest early in the morning and decreased thereafter (`r filter(flir_results_sum, RV == "cold_area" & grepl("s[(]day_mins", dropped_EV))$ref`), although their density remained constant (`r filter(flir_results_sum, RV == "cold_density" & grepl("s[(]day_mins", dropped_EV))$ref`). The Shape Index of cold spots decreased after dawn to its minimum value, and subsequently increased (`r filter(flir_results_sum, RV == "cold_shape_index" & grepl("s[(]day_mins", dropped_EV))$ref`). Aggregation Index, in contrast, increased to its maximum value after dawn, and subsequently decreased (`r filter(flir_results_sum, RV == "cold_aggregation" & grepl("s[(]day_mins", dropped_EV))$ref`). Overall, cold spots were larger, more regularly shaped and more clustered in the morning compared to noon.

(ref:cap-3-2) Trends in various measures of thermal heterogeneity over the day (06:00-14:30 hrs) for fine-scale temperature data collected using a thermal camera in primary (blue) and logged forests (orange). From left to right and top to bottom, the metrics are: median temperature (a); thermal Shannon Diversity Index (b); 95^th^ percentile minus median temperature (c); 5^th^ percentile minus median temperature (d); the average area (cm^2^) per hot spot (e); the average area (cm^2^) per cold spot (f); the number of hot spots per unit area (g); the number of cold spots per unit area (h); the Shape Index of hot spots (i); the Shape Index of cold spots (j); the Aggregation Index of hot spots (%) (k); and the Aggregation Index of cold spots (%) (l). Solid lines are model-predicted values with 95% confidence intervals. Semi-transparent background points represent the raw data. Statistically significant differences are indicated by asterisks: 0.01 < P < 0.05 (\*); 0.001 < P < 0.01 (\*\*) and P < 0.0001 (\*\*\*).

```{r fig-3-2, fig.cap= "(ref:cap-3-2)", fig.width = 16.6/2.54, fig.height=14/2.54, fig.align='center'}
p2 <-
    ggplot(data = flir_pred,
           aes(x = day_mins,
               y = RV_val,
               colour = forest_type))+
    geom_point(data = flir_dat,
               alpha = 0.1,
               size = 0.7) +
    geom_ribbon(aes(ymin = lwr,
                    ymax = upr,
                    fill = forest_type,
                    colour = NULL),
                alpha = 0.3) +
    geom_line() +
    facet_wrap(~RV_var, scales = "free", strip.position = "left") +
    theme_classic() +
    theme(axis.title = element_blank(),
          axis.text = element_text(size = text_size),
          legend.text = element_text(size = text_size),
          legend.position = "top",
          legend.key.size = unit(3, "mm"),
          legend.margin = margin(1,0,0,0),
          plot.margin = margin(0,5,5,5),
          panel.grid = element_blank(),
          panel.spacing.x = unit(-0.1, "cm"),
          strip.switch.pad.wrap = unit(0, "cm"),
          strip.placement = "outside",
          strip.background = element_blank(),
          strip.text = element_text(size = title_size))+
    scale_x_continuous(breaks = seq((60*6), (60*14), 120),
                       labels = sapply(seq(6,14,2), tidy_hour, separator = "")) +
    scale_colour_manual(values=c(cbPalette[6],cbPalette[7])) +
    scale_fill_manual(values=c(cbPalette[6],cbPalette[7])) +
    guides(fill=guide_legend(title = NULL),
           colour=guide_legend(title = NULL))

p2 <-
    ggdraw() +
    draw_plot(p2, x = 0, y = 0, width = 1, height = 1) +
    draw_plot_label(label = flir_stars$sig,
                    x = rep(c(0.17,0.42,0.665, 0.91), times = 3),
                    y = rep(c(0.951,0.635,0.32), each = 4),
                    hjust = 0.5,
                    size = lab_size) +
    draw_plot_label(label = paste("(", letters[1:12], ")", sep = ""),
                    x = rep(c(0.09,0.34,0.585, 0.83), times = 3),
                    y = rep(c(0.96,0.64,0.33), each = 4),
                    hjust = 0.5,
                    size = lab_size)
p2
# ggsave(plot = p2, filename = "figures/fig2.png",
#        width = 16.6, height = 14, units = "cm")

```

### Remote study

Thermal heterogeneity on Borneo varied over the year for most metrics considered. While average temperature peaked most notably around April-May (`r filter(worldclim_results_sum, RV == "median" & grepl("s[(]month", dropped_EV))$ref`), the thermal Shannon Diversity Index was greatest around September and January (`r filter(worldclim_results_sum, RV == "SHDI" & grepl("s[(]month", dropped_EV))$ref`) and the upper temperature range (95^th^ percentile minus median) had an inverse pattern to median temperature, being lowest in May and highest in December (`r filter(worldclim_results_sum, RV == "upr_range" & grepl("s[(]month", dropped_EV))$ref`). There was no clear seasonality in the lower temperature range (median minus 5^th^ percentile; `r filter(worldclim_results_sum, RV == "lwr_range" & grepl("s[(]month", dropped_EV))$ref`), nor the area (`r filter(worldclim_results_sum, RV == "cold_area" & grepl("s[(]month", dropped_EV))$ref`) and density (`r filter(worldclim_results_sum, RV == "cold_density" & grepl("s[(]month", dropped_EV))$ref`) of cold spots. The Shape Index of cold spots was highest in June and lowest in September (`r filter(worldclim_results_sum, RV == "cold_shape_index" & grepl("s[(]month", dropped_EV))$ref`), in contrast to the Aggregation Index of cold spots which peaked in September (`r filter(worldclim_results_sum, RV == "cold_aggregation" & grepl("s[(]month", dropped_EV))$ref`). Taken together, these results suggest that there is some annual variation in thermal heterogeneity, with more clustered and regularly shaped cold spots and greatest thermal diversity around September. 

(ref:cap-3-3) Trends in various measures of thermal heterogeneity over the year for temperature data from WorldClim2. From left to right and top to bottom, the metrics are: median temperature (a); thermal Shannon Diversity Index (b); 95^th^ percentile minus median temperature (c); 5^th^ percentile minus median temperature (d); the average area (cm^2^) per cold spot (e); the number of cold spots per unit area (f); the Shape Index of cold spots (g); and the Aggregation Index of cold spots (%) (h). Solid lines are model-predicted values with 95% confidence intervals. Points represent the raw data. Statistically significant differences are indicated by asterisks: 0.01 < P < 0.05 (\*); 0.001 < P < 0.01 (\*\*) and P < 0.0001 (\*\*\*). The dry season is indicated by a light grey vertical band from July to October.

```{r fig-3-3, fig.cap= "(ref:cap-3-3)", fig.width = 16.6/2.54, fig.height=14/2.54, fig.align='center'}

p3 <-
    ggplot(data = worldclim_pred,
           aes(x = month,
               y = RV_val))+
    geom_rect(aes(xmin = 7,
                  xmax = 10,
                  ymin = -Inf,
                  ymax = Inf),
                fill = "grey90") +
    geom_point(data = worldclim_raw) +
    geom_ribbon(aes(ymin = lwr,
                    ymax = upr),
                alpha = 0.3) +
    geom_line() +
    facet_wrap(~RV_var, scales = "free", strip.position = "left", ncol = 2) +
    theme_classic() +
    theme(axis.title = element_blank(),
          axis.text = element_text(size = text_size),
          plot.margin = margin(0,5,5,5),
          panel.grid = element_blank(),
          panel.spacing.x = unit(-0.1, "cm"),
          strip.switch.pad.wrap = unit(0, "cm"),
          strip.placement = "outside",
          strip.background = element_blank(),
          strip.text = element_text(size = title_size))+
    scale_x_continuous(breaks = 1:12,
                       labels = month.abb)

p3 <-
    ggdraw() +
    draw_plot(p3, x = 0, y = 0, width = 1, height = 1) +
    draw_plot_label(label = worldclim_stars$sig,
                    x = rep(c(0.3, 
                              0.79), times = 4),
                    y = rep(c(0.996,
                              0.75,
                              0.51,
                              0.255), each = 2),
                    hjust = 0.5,
                    size = lab_size)+
    draw_plot_label(label = paste("(", letters[1:8], ")", sep = ""),
                    x = rep(c(0.12, 
                              0.6), times = 4),
                    y = rep(c(1,
                              0.76,
                              0.51,
                              0.256), each = 2),
                    hjust = 0.5,
                    size = lab_size)
p3
```

## Discussion

Our `R` package presents users with a simple protocol for processing and analysing thermal images. Although tailored towards images collected in the field using a FLIR camera, we demonstrate its applicability for other forms of gridded temperature data. In particular, we facilitate the calculation of various metrics of thermal heterogeneity collated from the literature [@shi_framework_2016; @faye_toolbox_2016], which are considered biologically important in the context of thermoregulation and are not readily captured by existing methods.

### Case studies

We found a strong effect of time on nearly all metrics of fine-scale thermal heterogeneity, in both intensively logged and unlogged forests on Borneo. Average temperature was lowest around dawn (~06:00 hrs) and peaked around noon (~12:00 hrs). Organisms are most likely to be seeking above-average temperatures for basking after sunrise, at which point hot spots were smaller in area but more numerous, more irregular in shape and less clustered, thus potentially easier to locate [@sears_configuration_2016]. Conversely, cold spots are necessary to buffer organisms against extremes of heat, which are most likely encountered at noon. At this time there was the greatest difference between minimum and average temperature, and cold spots were likely to be easier to locate because of a more irregular shape and lack of spatial clustering. Temperature variation in both time and space was comparable between forest types (\autoref{fig:fig-3-2}), confirming the findings of [Chapter 4](#ch4) that within a few years of recovery, intensively logged forest can have an equal capacity for thermal buffering as nearby unlogged forest.

Despite the coarseness of the data from WorldClim2 and general lack of seasonality on Borneo [e.g. @walsh_ecoclimatology_1999], some temporal patterns were apparent. Namely, thermal diversity and clustering of cold spots were highest in September and October when the regularity of cold spot shape was lowest (\autoref{fig:fig-3-3}). This marks the end of the dry season [@mcalpine_forest_2018], at which point lower water availability may decrease heat loss through evaporation [@oke_boundary_1987], causing some locations to deviate more from the regional average temperature and thereby increasing overall thermal diversity.

### Caveats and considerations

It is important to consider the strengths and weaknesses of thermography when deciding on the most appropriate methodology to answer the research questions of interest. Thermal cameras cannot directly measure sub-surface temperatures and are not as well suited for capturing temporal variation as dataloggers. Although affordable smartphone attachments are now available, thermal cameras may still be more expensive than dataloggers (depending on the quantity of dataloggers required), and can be sensitive to extreme weather conditions common to regions such as the tropics and Arctic [@flir_manual_2016]. @bramer_advances_2018 is an excellent resource for ecologists seeking best practice for using dataloggers; we hope that our study and the references herein offer something analogous for ecologists using thermography.

### Summary

Fine-scale temperature variation across space and time has a huge influence on species' ecology, which will become increasingly pertinent as average temperatures rise under global climate warming. We showcase how our `R` package and framework can be used to quantify thermal heterogeneity in tropical forests using data at a fine spatial scale, collected using a FLIR thermal camera. We also show how our metrics can be calculated for other kinds of gridded temperature data, such as remotely sensed data. By simplifying and streamlining the processing of increasingly available thermal imagery, our approach enables researchers to more readily address key issues in ecology and conservation.

## Code availability

The `R` package `ThermStats` can be downloaded from GitHub: https://github.com/rasenior/ThermStats. Bug reports and suggested enhancements can be submitted to: https://github.com/rasenior/ThermStats/issues. 

## Acknowledgements

Thanks to Manoela S. Machado Mollinari for helpful discussions. R.A.S. was funded by a NERC studentship through the ACCE (Adapting to the Challenges of a Changing Environment) Doctoral Training Partnership (Grant No. NE/L002450/1).