```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = FALSE,message = FALSE,error = FALSE, warning = FALSE, 
                      fig.width = 16.6/2.54, fig.height = 10/2.54, dpi = 800, 
                      fig.path = "./output/", fig.align = "centre")
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")

library(ggplot2)
library(viridis)
library(scales)
library(dplyr)
library(cowplot)
library(rgdal)
library(rgeos)

# Plotting parameters
text_size <- 6
title_size <- 8
lab_size <- 7
cbpal1 <- viridis(4, option = "D")
cbpal2 <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#CC79A7", "#D55E00","#0072B2")

tf <- trans_format("log1p", math_format())
wgs84 <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
cea <- "+proj=cea +lon_0=0 +lat_ts=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"

get_signif <- function(p_val){
    signif_level <- 
        ifelse(p_val >0.05, paste("= ", signif(p_val, 3), sep = ""),
               ifelse(p_val <= 0.05 & p_val >0.01, "<0.05",
                      ifelse(p_val <= 0.01 & p_val >0.001, "<0.01", 
                             "<0.001")))
    return(signif_level)
}

```

```{r load-results, include = FALSE}
load("data/ch5/models/median-cc.Rdata")
load("data/ch5/models/prop-success.Rdata")
load("data/ch5/models/prop-cc-loss.Rdata")
load("data/ch5/pantropics/map_dat.Rdata")
load("data/ch5/pantropics/stat_dat.Rdata")
rm(ccc_bi_exc, ccc_bi_exc_df,
   ccc_bi_inc, ccc_bi_inc_df,
   ccc_polys_df,
   region_ccc_exc)
```

```{r prep-results, include = FALSE}
### Median cc
median_cc_interaction <- 
    data.frame(median_cc_interaction) %>% 
    mutate(RV = "median_cc",
           EV = "interaction",
           stat = "F",
           stat_val = F,
           P = Pr..F.,
           p_val = get_signif(Pr..F.),
           fig_ref = "\\autoref{fig:fig-5-2}") %>% 
    filter(!(is.na(Df))) %>% 
    select(RV, EV, Df, stat, stat_val, P, p_val, fig_ref) %>% 
    mutate(ref = paste(stat, " = ", signif(stat_val,3), ", ",
                       "p ", p_val, 
                       "; ", fig_ref,
                       sep = ""))
median_cc_results <- 
    data.frame(anova(median_cc_mod)) %>% 
    mutate(RV = "median_cc",
           EV = row.names(.),
           stat = "F",
           stat_val = F.value,
           P = Pr..F.,
           p_val = get_signif(Pr..F.),
           fig_ref = "\\autoref{fig:fig-5-2}a") %>% 
    filter(EV != "Residuals") %>% 
    select(RV, EV, Df, stat, stat_val, P, p_val, fig_ref) %>% 
    mutate(ref = paste(stat, " = ", signif(stat_val,3), ", ",
                       "p ", p_val, 
                       "; ", fig_ref,
                       sep = ""))

# Sort predicted results for 2012 into order, lowest to highest
median_cc_dat_2012 <-
    median_cc_dat %>% 
    filter(year == "2012") %>% 
    arrange(median_cc) %>% 
    mutate(median_cc = signif(median_cc,3))

# Overall median (across everything)
median_cc_2012 <- median(patches$cc[patches$year == "2012"])

### Proportion connected area
prop_success_interaction <- 
    data.frame(prop_success_interaction) %>% 
    mutate(RV = "prop_success",
           EV = "interaction",
           stat = "F",
           stat_val = F,
           P = Pr..F.,
           p_val = get_signif(Pr..F.),
           fig_ref = "\\autoref{fig:fig-5-2}b") %>% 
    filter(!(is.na(Df))) %>% 
    select(RV, EV, Df, stat, stat_val, P, p_val, fig_ref) %>% 
    mutate(ref = paste(stat, " = ", signif(stat_val,3), ", ",
                       "p ", p_val, 
                       "; ", fig_ref,
                       sep = ""))

prop_success_results <-
    data.frame(anova(prop_success_mod,test="F")) %>% 
    mutate(RV = "prop_success",
           EV = row.names(.),
           stat = "F",
           stat_val = F,
           P = Pr..F.,
           p_val = get_signif(Pr..F.),
           fig_ref = "\\autoref{fig:fig-5-2}b") %>% 
    filter(!(is.na(p_val))) %>% 
    select(RV, EV, Df, stat, stat_val, P, p_val, fig_ref) %>% 
    mutate(ref = paste(stat, " = ", signif(stat_val,3), ", ",
                       "p ", p_val, 
                       "; ", fig_ref,
                       sep = ""))

# Total successful area
success_area <- sum(region_cc$success_patch_area[region_cc$year == "2012"])
fail_area <- sum(region_cc$fail_patch_area[region_cc$year == "2012"])
total_area <- sum(region_cc$sum_patch_area[region_cc$year == "2012"])

prop_success_dat_2012 <-
    prop_success_dat %>% 
    filter(year == "2012") %>% 
    arrange(prop_success) %>% 
    mutate(prop_success = signif(prop_success * 100,3))
prop_success_dat_yr <-
    prop_success_dat %>% 
    group_by(realm) %>% 
    summarise(prop_success_diff = diff(prop_success)) %>% 
    mutate(prop_success_diff = (signif(prop_success_diff * 100, 3))) %>% 
    arrange(prop_success_diff)

### Proportion cc loss
cc_loss_results <-
    cc_loss_results %>%
    mutate(RV = "cc_loss",
           stat_val = as.numeric(paste(stat_val)),
           P = as.numeric(paste(P)),
           p_val = get_signif(P),
           fig_ref = c("\\autoref{fig:fig-5-3}",
                       "\\autoref{fig:fig-C-1}",
                       "\\autoref{fig:fig-5-3}")) %>% 
    select(RV, EV, Df, stat, stat_val, P, p_val, fig_ref) %>% 
    mutate(ref = paste(stat, " = ", signif(stat_val,3), ", ",
                       "p ", p_val, 
                       "; ", fig_ref,
                       sep = ""))

region_ccc_inc$tc_loss_log1p <- log1p(region_ccc_inc$tc_loss)
region_ccc_inc$prop_decrease_cc <-
    region_ccc_inc$area_decrease_cc /
    region_ccc_inc$sum_patch_area

cc_decrease_area <- sum(region_ccc_inc$area_decrease_cc)
cc_increase_area <- sum(region_ccc_inc$area_increase_cc)
total_ccc_area <- sum(region_ccc_inc$sum_patch_area)

results <- rbind(median_cc_results, prop_success_results, cc_loss_results)

```

```{r prep-4-plotting, include = FALSE}
# Read in background realm polygons
realms <-
    readOGR("data/ch5/pantropics/plotting_boundaries", "realms_sub",
            use_iconv = TRUE, encoding = "UTF-8") %>% 
    # Reproject
    spTransform(CRS(cea)) %>% 
    # Correct topography
    gBuffer(byid=TRUE, width=0)

# Sort attribute table
realms_df <- 
    realms@data

# Fortify polygons
realms <- fortify(realms, region = "realm")

# Merge polygons with attribute table
realms <- 
    merge(realms, realms_df,
          by.x = "id", 
          by.y = "realm") %>% 
    rename(realm = id) %>%
    mutate(realm = factor(realm, 
                          levels = c("Neotropics",
                                     "Afrotropics",
                                     "Indomalaya",
                                     "Australasia",
                                     "Oceania")))

# Reduce patch polys to 2012 only
patches <- patches[patches$year == "2012",]

# Add region info
patches <- merge(patches, boundaries_df, by = "region")
ccc_polys <- merge(ccc_polys, boundaries_df, by = "region")
ccc_polys$year <- "2012 - 2000"

# Remove regions < 5000 km^2
patches <- patches[patches$region_area >= 5000,]
ccc_polys <- ccc_polys[ccc_polys$region_area >= 5000,]

# Define function to adjust lat/long for Oceania
adj_oceania <- function(df, long_adj, lat_adj, vline, hline){
    
    # Need to add Oceanian points in Western hemisphere to Eastern hemisphere
    df[df[,"realm"] == "Oceania" & df[, "long"] < 0, "long"] <-
        (df[df[,"realm"] == "Oceania" & df[, "long"] < 0, "long"]) + long_adj
    
    # Need to add Oceanian points in Northern hemisphere to Southern hemisphere
    df[df[,"realm"] == "Oceania" & df[, "lat"] > 0, "lat"] <-
        (df[df[,"realm"] == "Oceania" & df[, "lat"] > 0, "lat"]) + lat_adj
    
    # Return
    return(df)
}

realms <- adj_oceania(realms, 
                      # Max long (180 degrees) plus extra adjustment
                      long_adj = 20037507.067162 + 17400000, 
                      lat_adj = - 3600000)
patches <- adj_oceania(patches, 
                       # Max long (180 degrees) plus extra adjustment
                       long_adj = 20037507.067162 + 17400000, 
                       lat_adj = - 3600000)
ccc_polys <- adj_oceania(ccc_polys, 
                         # Max long (180 degrees) plus extra adjustment
                         long_adj = 20037507.067162 + 17400000, 
                         lat_adj = - 3600000)

# Define extras for Oceania facet
oceania_labs <- 
    data.frame(realm = "Oceania",
               lab = c("Fiji",
                       "Fiji",
                       "Hawaii"),
               long = c(rep(19800000,2),
                        20150000),
               lat = c(rep(-1700000,2),
                       -1600000),
               vline = 20050000,
               hline = -1630000,
               x = c(19800000,
                     19800000,
                     20150000),
               y = c(-1730000,
                     -1730000,
                     -1590000),
               xend = c(19850000,
                        19900000,
                        20160000),
               yend = c(-1890000,
                        -1800000,
                        -1520000))

# Relevel realm
patches$realm <- factor(patches$realm,
                        levels = c("Neotropics",
                                   "Afrotropics",
                                   "Indomalaya",
                                   "Australasia",
                                   "Oceania"))
ccc_polys$realm <- factor(ccc_polys$realm,
                          levels = c("Neotropics",
                                     "Afrotropics",
                                     "Indomalaya",
                                     "Australasia",
                                     "Oceania"))

```

# Global loss of climate connectivity in tropical forests

\begin{figure}[!htb]
\centering
\includegraphics[width=15cm]{pics/landscape1.jpg}
\caption*{Mixed use tropical landscape in Bali.}
\end{figure}

This chapter is currently in preparation for submission to *Nature* as:

**Senior RA, Hill JK, Edwards DP. Global loss of climate connectivity in tropical forests. In prep.**

\pagebreak

## Abstract

Range shifts are a crucial mechanism enabling species to avoid extinction under climate change. The majority of terrestrial biodiversity is concentrated in the tropics, including species considered most vulnerable to climate warming, but extensive and ongoing deforestation of tropical forests is likely to impede range shifts. We conduct the first global assessment of the potential for tropical species to reach analogous future climates -- so-called 'climate connectivity' -- and then empirically test how this potential has changed in response to deforestation between 2000 and 2012. Over `r signif((fail_area / total_area) * 100, 2)`% of tropical forest is already incapable of facilitating range shifts to analogous future climates. On average, if species' ranges shift as far down climate gradients as permitted by existing forest connectivity, organisms would still experience `r -signif(median_cc_2012,2)`&deg;C of warming by 2070. In just 12 years over `r signif((cc_decrease_area / total_ccc_area) * 100, 2)`% of tropical forest experienced a loss of climate connectivity, with accelerating declines as forest loss increased.  Limiting further forest loss and directing the 350 million hectares of forest restoration under the Bonn Challenge to create climate corridors are global priorities for improving resilience of tropical forests under climate change. 

## Introduction

To avoid extinction under climate change, species must either adapt *in situ* or shift their range [@hobbs_movers_2018]. Both strategies have been widely studied, with range shifts polewards or upwards appearing to be a widespread response to climate change across the globe, in both paleo-ecological records and under modern climate change [@parmesan_ecological_2006], and across a range of taxa [@chen_rapid_2011]. There is potential for other human impacts, including land-use change, to influence the ability of species to shift their ranges in response to climate change. Understanding the interactions between climate change and habitat change is therefore a conservation priority [@sirami_impacts_2017]. 

Land-use change impedes range shifts in most cases, by creating highly fragmented landscapes through which many species struggle to navigate [@tucker_moving_2018]. The tropics is an area of particular concern because it retains most remaining terrestrial biodiversity [@jenkins_global_2013] while also being the focus of extensive land-use change through the conversion and degradation of tropical forests [@hansen_high-resolution_2013; @lewis_increasing_2015]. Although the absolute magnitude of climate change will be greatest at the poles [@ipcc_climate_2013], long periods of climatic stability mean it is the tropics where relative climate change will be the most severe [@mora_projected_2013]. Many tropical species have limited tolerance for temperature change [@tewksbury_putting_2008], and are also highly sensitive to fragmentation because of habitat specialism and poor dispersal ability [@opdam_climate_2004]. Climate-driven range shifts in the tropics generally follow elevational gradients, probably because latitudinal temperature gradients are very shallow [@loarie_velocity_2009]. Range shifts of tropical species have been documented in response to warming from as little as 0.1-0.76&deg;C [@raxworthy_extinction_2008; @chen_elevation_2009].

The potential for species to shift their range in response to climate change depends both on the future availability of suitable habitat with an analogous climate and the connectivity between the species' current distribution and potential future habitat. Species Distribution Models (SDMs) have been key in addressing the former, using the correlation between current distribution and current abiotic conditions (including climate) to forecast where species might go in the future [@hijmans_ability_2006]. However, not only do SDMs fail to consider connectivity, they are also fine-filter approaches focusing on specific species and requiring a wealth of data [@nunez_connectivity_2013]. Equally, there is a plethora of studies that quantify habitat connectivity -- both structural and actual connectivity -- which have been instrumental in highlighting the extent of fragmentation by land-use change [@tucker_moving_2018; @cosgrove_consequences_2017], but do not explicitly consider climate. This is important because large areas of structurally connected habitat could still become unsuitable under climate change if there is insufficient climatic heterogeneity within the region (e.g. lowland rainforest). 

Studies that do integrate habitat connectivity with climate are highly informative both for quantifying the current connectedness of natural areas to future climate analogues, and for predicting specific movement routes or 'climate corridors' between source and target areas [@lawler_projected_2013; @mcguire_achieving_2016; @littlefield_connecting_2017]. That said, 'climate connectivity' -- the spatial configuration of natural lands that allows species to track their current climatic conditions during projected climate change [@mcguire_achieving_2016] -- has yet to be reviewed across the tropics, nor has any study to date utilised empirical data to examine change in climate connectivity over time. The latter is key if we are to understand patterns of climate connectivity change, and thereby strategically plan loss, gain or protection of tropical forests to maximise climate resilience.

In this study, we combined current and future climate data with data from tropical land-use change that has already occurred, to quantify both the current climate connectivity across the tropics, and the patterns of change in the recent past. We hypothesised that current climate connectivity, in terms of its average value and the area of successfully connected forest, would vary across biogeographic realms, according to differences in biogeography and land-use history. Loss of climate connectivity will invariably depend on loss of forest area, but we expected greater loss of climate connectivity in regions with low starting climate connectivity (in 2000) and beyond a critical level of forest loss.

## Materials and Methods

We focused our study on the pantropics, including all land masses located between &plusmn;23.4&deg; latitude. We excluded land masses smaller than the minimum permissible area for forest patches (10 km^2^; see 'Climate-partitioned forest patches'), as well as those with a temperature range less than the predicted temperature change under climate warming, since range shifts are unlikely to be sufficient responses to climate change in these regions. Boundaries were initially buffered by 100 km to reduce artificial truncation of climate gradients for those land masses with a true extent beyond the tropics [e.g. Africa and Australia; cf. @mcguire_achieving_2016]. Maps were analysed at 1-km resolution projected into the World Cylindrical Equal Area projection. All spatial layers were processed with Python code implemented using the arcpy module in ArcMap version 10.4.1 [@esri_arcgis].

### Climate-partitioned forest patches

Since we were interested in climate connectivity for species inhabiting tropical forests, we calculated climate connectivity based on movement along a temperature gradient within forested areas only. We defined cells as forest or non-forest using tree cover data from @hansen_high-resolution_2013. For the year 2000, cells were defined as forested if they had >50% tree cover [@hansen_high-resolution_2013]. Results are conservative because the @hansen_high-resolution_2013 dataset does not differentiate between natural forest and tree plantations, but see Supplementary Text S1 for analyses excluding cells within tree plantations, for those countries (Brazil, Cambodia, Colombia, Indonesia, Liberia, Malaysia, and Peru) where plantation boundaries were available [@transparent_world_tree_2015]. For the year 2012, cells were classified based on forest loss and forest gain [@hansen_high-resolution_2013] relative to forest cover in 2000. If a cell had experienced forest loss from 2000 to 2012, it had gone from a forested to non-forested state and the cell was classed as non-forest in 2012. Conversely, if a cell had experienced forest gain from 2000 to 2012, it had gone from a non-forested to a forested state; providing there had been no concomitant loss, the cell was classed as forest in 2012. 

We partitioned forest patches using a present-day (~1950-2000), 30-arc-second global layer for Mean Annual Temperature (hereafter: temperature) from the WorldClim database [Version 1.4; @hijmans_very_2005; @mcguire_achieving_2016], resampled to 1 km^2^. The same approach was applied separately to forest cover in 2000 and 2012: temperature values were assigned to forested cells and reclassified to increments of 0.5&deg;C, based on evidence that tropical species are sensitive to this degree of temperature difference [e.g. @freeman_rapid_2014; @raxworthy_extinction_2008]. The resulting raster was converted to polygons, whereby neighbouring forest cells with the same temperature value were assigned to the same polygon (hereafter: forest patch). While our approach is not specific to any particular taxon, it may be helpful to consider the method in the context of range shifts by non-volant terrestrial animals [cf. @nunez_connectivity_2013]. We removed forest patches <10 km^2^, based on the assumption that they could not support a population for long enough to enable range shifts [REF]. Patches within 2 km of each other were assigned to the same patch, conservatively assuming that populations could move across 2 km of non-forest to reach suitable habitat [REF]. See Supplementary Text S2 for the implications of varying these parameters.

### Climate connectivity

The logic behind the measure of climate connectivity in @mcguire_achieving_2016 is that it represents the maximum temperature differential between current and future conditions that can be achieved by traversing a gradient from hotter to cooler patches within existing natural habitat. We assigned mean current and future temperature to all forest patches, again using data from WorldClim. Future temperature was for the year 2070 (2061-2080), derived from the HadGEM2-AO general circulation model [@ipcc_climate_2013] and Representative Concentration Pathway (RCP) 8.5, which is the most severe ('business-as-usual') IPCC scenario. 

To trace each forest patch to its final destination, we identified which patches were neighbours, and iterated over all unique temperatures from cooler to hotter, each time identifying the patch(es) corresponding to that temperature and the identity of its coolest neighbour. For patches with no cooler neighbours, the final destination patch is assigned as itself. For all other patches, the destination is assigned as the final destination of its coolest immediate neighbour. This algorithm ensures that the coolest destinations are passed on with each iteration, enabling destination patches to extend beyond immediate neighbours. See Supplementary Text S3 for a full worked example [@mcguire_achieving_2016].

Once each origin patch has a designated final destination patch, climate connectivity is calculated as the temperature differential between them. The key question is whether forest cover is sufficient for organisms to reach a place that, under future climate warming, is the same as or cooler than the temperature of their current location. Thus, climate connectivity is the current temperature of the origin patch minus the future temperature of the destination patch. Where this value is zero or positive, the patch has achieved successful climate connectivity: there is sufficient structural connectivity between forested areas for organisms to reach forest that is same as or cooler than the temperatures they currently experience. Negative values indicate that the coolest reachable forest is still warmer under climate change than the current temperature, and inhabitant organisms would fail to reach an analogous climate under projected warming.

### Statistical analyses

All data were analysed in R [version 3.5.0; @r_core_team_2018]. For all models, statistical significance was inspected by dropping each fixed effect in turn and comparing to the full model [@zuur_mixed_2009]. The significance of main effects involved in an interaction was assessed in the same way, except reduced models were compared to a full model without the interaction term.

#### Current state of climate connectivity

Climate connectivity was necessarily calculated at a patch-level, but because patches themselves were not constant through time our spatial unit of replication was land mass (417 in total, comprising islands as well as contiguous sections of continents clipped to the extent of the tropics). To assess current status we calculated median climate connectivity for each land mass, as well as the proportion of the total area of forested patches that were successfully connected (climate connectivity &ge;0; hereafter: proportional area of successful connectivity). 

Median climate connectivity and proportional area of successful connectivity were modelled against year (categorical: 2000 or 2012) and biogeographic realm (categorical: Australasia,  Indomalaya, Neotropics, Afrotropics and Oceania), with an interaction between them. Both response variables were fit using the lme4 package [@bates_fitting_2015]. Median climate connectivity was modelled using a simple linear model. Proportional area of successful connectivity was modelled as a binary variable (sum patch area with climate connectivity &ge;0 versus sum patch area with climate connectivity <0), using a generalized linear model (GLM) with a quasibinomial error distribution; the quasi-variant of this distribution was necessary because of overdispersion. For both response variables, model comparisons were performed using F tests.

#### Change in climate connectivity

Change of climate connectivity from 2000 to 2012 was first calculated at the level of the grid cell. For both years, we created a binary raster of climate connectivity, where cells were either successful (climate connectivity &ge;0) or unsuccessful (climate connectivity <0). Change was then calculated as climate connectivity in 2012 minus climate connectivity in 2000, and could take one of three values: no change (value of 0), loss of climate connectivity (value of -1), or gain of climate connectivity (value of 1). Where cells changed from a forested to a non-forested state, we assume a loss of climate connectivity for that cell. Where cells changed from a non-forested to a forested state [e.g. via secondary forest regrowth on abandoned farmland; @aide_deforestation_2013], we assume a gain of climate connectivity for that cell. For analyses, loss of climate connectivity was captured by the proportion of the total area of forested cells (forested in either 2000, 2012 or both) that experienced a change from successful to unsuccessful climate connectivity (hereafter: proportional area of connectivity loss). An analogous approach was applied to capture gain of climate connectivity.

Area of connectivity loss was directly modelled as proportion data, against the explanatory variables: biogeographic realm, area of forest cover in 2000 and area of forest loss from 2000 to 2012. A binomial GLM was not appropriate in this case because many small land-masses experienced zero change in area of connectivity loss, thus inflating the data with true zeroes. Instead, we used a General Additive Model with a zero-inflated beta distribution [@ospina_general_2012], implemented in the gamlss package [@rigby_generalized_2005], which has the added benefit of allowing for nonlinear relationships. Model comparisons were performed using likelihood ratio tests.

## Results

### Current state of climate connectivity

Across the tropics, raw climate connectivity in 2012 ranged from a minimum of `r signif(min(patches$cc[patches$year == "2012"]),3)`&deg;C to a maximum of `r signif(max(patches$cc[patches$year == "2012"]),3)`&deg;C, with a median value of `r signif(median(patches$cc[patches$year == "2012"]),3)`&deg;C (\autoref{fig:fig-5-1}a). Median climate connectivity varied by biogeographic realm (`r median_cc_results$ref[median_cc_results$EV == "realm"]`), with the lowest value for the Neotropical realm (`r median_cc_dat_2012$median_cc[1]`&deg;C), followed by the Afrotropics (`r median_cc_dat_2012$median_cc[2]`&deg;C), Indomalaya (`r median_cc_dat_2012$median_cc[3]`&deg;C), Australasia (`r median_cc_dat_2012$median_cc[4]`&deg;C) and Oceania (`r median_cc_dat_2012$median_cc[5]`&deg;C). Thus, for any given biogeographic realm, the average forested area is not sufficiently connected along a temperature gradient to enable species to avoid climate change by shifting their distribution. 

Overall, `r signif((success_area / total_area) * 100,3)`% of tropical forests currently achieve successful climate connectivity. There was considerable variation across realms (`r prop_success_results$ref[prop_success_results$EV == "realm"]`). The least successful realm was Indomalaya, with only `r prop_success_dat_2012$prop_success[1]`% of its forested area achieving connectivity, followed by the Afrotropics (`r prop_success_dat_2012$prop_success[2]`%), Oceania (`r prop_success_dat_2012$prop_success[3]`%), the Neotropics (`r prop_success_dat_2012$prop_success[4]`%) and Australasia (`r prop_success_dat_2012$prop_success[5]`%). More than half of forest is connected along climate gradients for most realms, suggesting that large patches with high climate connectivity can somewhat compensate for poor average climate connectivity.

(ref:cap-5-1) Climate connectivity in 2012 (a) and change in climate connectivity from 2000 to 2012 (b). Positive values (blue) indicate successful climate connectivity in panel a, or a gain of connectivity in panel b. Negative values (red) indicate unsuccessful climate connectivity in panel a, or a loss of connectivity in panel b.

```{r fig-5-1, fig.cap= "(ref:cap-5-1)", fig.height=6/2.54}

p1a <-
    ggplot() +
    # Realms
    geom_polygon(data = realms,
                 aes(x = long,
                     y = lat,
                     group = group),
                 fill = "grey20") +
    # Line to delineate W/E hemisphere
    geom_vline(data = oceania_labs,
               aes(xintercept = vline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20") +
    # Line to delineate N/S hemisphere
    geom_hline(data = oceania_labs,
               aes(yintercept = hline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20")+
    # Oceania labels
    geom_text(data = oceania_labs,
              aes(x = long,
                  y = lat,
                  label = lab),
              size = 2) +
    # Oceania arrows
    geom_segment(data = oceania_labs,
                 aes(x = x,
                     y = y,
                     xend = xend,
                     yend = yend),
                 size = 0.2) +
    # Cc polygons
    geom_polygon(data = patches,
                 aes(x = long,
                     y = lat,
                     group = group,
                     fill = cc)) +
    facet_wrap( ~ realm,
                scales = "free",
                nrow = 1) +
    theme_bw() +
    ylab("2012") +
    theme(axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.ticks = element_blank(),
          plot.margin = margin(1, 2, 1, 2),
          panel.background = element_rect(fill = "darkseagreen3"),
          panel.grid = element_blank(),
          panel.spacing.x = unit(-0.2, units = "lines"),
          panel.spacing.y = unit(0, units = "lines"),
          strip.background = element_blank(),
          strip.text = element_text(size = title_size,
                                    hjust = 0.5),
          legend.text = element_text(size = text_size),
          legend.title = element_text(size = text_size),
          legend.box.spacing = unit(0,"cm"),
          legend.box.margin = margin(0,0,0,2),
          legend.position = "right") +
    # scale_x_continuous(expand = c(0, 0))+
    scale_y_continuous(expand = c(0, 0))+
    coord_equal(ratio=1) +
    scale_fill_gradient2(low = "red4",
                         mid = "beige",
                         high = "dodgerblue") +
    guides(fill = guide_colourbar(raster = FALSE, 
                                  barwidth = unit(3, units = "mm"),
                                  barheight = unit(2, units = "cm"),
                                  direction = "vertical",
                                  title.vjust = 1,
                                  title.position = "top",
                                  title = paste("Climate\nconnectivity (",
                                                "\U00B0","C)",sep="")))


p1b <-
    ggplot() +
    # Realms
    geom_polygon(data = realms,
                 aes(x = long,
                     y = lat,
                     group = group),
                 fill = "grey20") +
    # Line to delineate W/E hemisphere
    geom_vline(data = oceania_labs,
               aes(xintercept = vline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20") +
    # Line to delineate N/S hemisphere
    geom_hline(data = oceania_labs,
               aes(yintercept = hline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20")+
    # Oceania labels
    geom_text(data = oceania_labs,
              aes(x = long,
                  y = lat,
                  label = lab),
              size = 2) +
    # Oceania arrows
    geom_segment(data = oceania_labs,
                 aes(x = x,
                     y = y,
                     xend = xend,
                     yend = yend),
                 size = 0.2) +
    # Cc polygons
    geom_polygon(data = ccc_polys,
                 aes(x = long,
                     y = lat,
                     group = group,
                     fill = cc_change)) +
    facet_wrap( ~ realm,
                scales = "free",
                nrow = 1) +
    theme_bw() +
    ylab("2012 - 2000") +
    theme(axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.ticks = element_blank(),
          plot.margin = margin(1, 2, 1, 2),
          panel.background = element_rect(fill = "darkseagreen3"),
          panel.grid = element_blank(),
          panel.spacing.x = unit(-0.2, units = "lines"),
          panel.spacing.y = unit(0, units = "lines"),
          strip.background = element_blank(),
          strip.text = element_blank(),
          legend.text = element_text(size = text_size),
          legend.title = element_text(size = text_size),
          legend.box.spacing = unit(0,"cm"),
          legend.box.margin = margin(0,0,0,0),
          legend.position = "right") +
    # scale_x_continuous(expand = c(0, 0))+
    scale_y_continuous(expand = c(0, 0))+
    coord_equal(ratio=1) +
    scale_fill_gradient2(low = "red4",
                         mid = "beige",
                         high = "dodgerblue") +
    guides(fill = guide_colourbar(raster = FALSE, 
                                  barwidth = unit(3, units = "mm"),
                                  barheight = unit(2, units = "cm"),
                                  direction = "vertical",
                                  title.vjust = 1,
                                  title.position = "top",
                                  title = paste("\U0394 ",
                                                "Climate\nconnectivity (",
                                                "\U00B0","C)",sep="")))

p1 <-
    plot_grid(p1a, p1b, 
              nrow = 2, ncol = 1,
              align = "hv", 
              labels = c("(a)", "(b)"), 
              label_size = lab_size)
    # draw_plot_label(label = ,
    #        x = c(rep(0.1, 2)),
    #        y = c(0.8, 0.1),
    #        size = 2)
p1

# ggsave(plot = p1, filename = "figs/map.png", dpi = 1000,
#        width = 16.6, height = 8, units = "cm")

```

(ref:cap-5-2) Climate connectivity of land masses in different biogeographic realms in the year 2000 (green) and 2012 (purple). Panel a shows results for median climate connectivity, with the dashed line indicating zero climate connectivity, at which point and above successful climate connectivity is achieved. Panel b shows results for the proportion of total forested area that achieves successful climate connectivity. Solid points are model-predicted values with 95% confidence intervals. Raw data are plotted in the background as semi-transparent points.

```{r fig-5-2, fig.cap= "(ref:cap-5-2)"}

p2a <-
ggplot(data = median_cc_dat, 
       aes(x = year,
           y = median_cc,
           colour = year)) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    geom_jitter(data = region_cc,
                alpha = 0.2,
                shape = 16,
                size= 1) +
    geom_point(position = position_dodge(width = 0.5)) +
    geom_errorbar(aes(ymin = lwr, ymax = upr), 
                  width = 0.2,
                  position = position_dodge(width = 0.5)) +
    facet_wrap(~ realm, nrow = 1, strip.position="bottom") +
    ylab(paste("Median climate connectivity (", "\U00B0","C)",sep="")) +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.text.y = element_text(size = text_size),
          strip.text = element_text(size = lab_size),
          legend.title = element_blank(),
          legend.text = element_text(size = lab_size),
          legend.position = c(0.1, 0.87), 
          legend.direction = "vertical",
          legend.key.size = unit(5, units = "mm"),
          # legend.background = element_rect(fill = "pink"),
          legend.margin = margin(0,0,0,0),
          panel.spacing = unit(0, units = "cm"),
          panel.grid = element_blank()) +
    scale_y_continuous(breaks = seq(-4,4,0.5)) +
    scale_colour_manual(values = cbpal1[c(3,1)])

p2b <-
ggplot(data = prop_success_dat, 
       aes(x = year,
           y = (prop_success * 100),
           colour = year)) +
    geom_point(position = position_dodge(width = 0.5)) +
    geom_errorbar(aes(ymin = lwr * 100, ymax = upr * 100), 
                  width = 0.2,
                  position = position_dodge(width = 0.5)) +
    geom_jitter(data = region_cc,
                aes(y = (success_patch_area / sum_patch_area) * 100),
                alpha = 0.2,
                shape = 16,
                size= 1) +
    facet_wrap(~ realm, nrow = 1, strip.position="bottom") +
    ylab("Area successful connectivity (%)") +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.text.y = element_text(size = text_size),
                    strip.text = element_text(size = lab_size),
          legend.title = element_blank(),
          legend.text = element_text(size = 4),
          legend.position = "none", 
          legend.direction = "horizontal",
          panel.spacing = unit(0, units = "cm"),
          panel.grid = element_blank()) +
    scale_y_continuous(breaks = seq(-0,100,10)) +
    scale_colour_manual(values = cbpal1[c(3,1)])

p2 <-
    plot_grid(p2a, p2b, 
              nrow = 1, ncol = 2,
              align = "hv",
              labels = c("(a)", "(b)"), 
              label_size = lab_size)
p2

# ggsave(plot = p2, filename = "figs/cc_results.png", dpi = 800,
#        width = 16.6, height = 8, units = "cm")
```

### Change in climate connectivity

Despite the short time interval, change in climate connectivity from 2000 to 2012 was widespread across the tropics (\autoref{fig:fig-5-1}b). Median climate connectivity did not differ between years (`r median_cc_results$ref[median_cc_results$EV == "year"]`), and this relationship was not affected by biogeographic realm (`r median_cc_interaction$ref`). However, the proportion of forested area that was successfully connected decreased from 2000 to 2012 (`r prop_success_results$ref[prop_success_results$EV == "year"]`). This pattern was consistent across realms (`r prop_success_interaction$ref`), with the biggest losses seen in Indomalaya (`r prop_success_dat_yr$prop_success_diff[1]`%), followed by the Afrotropics (`r prop_success_dat_yr$prop_success_diff[2]`%), Oceania (`r prop_success_dat_yr$prop_success_diff[3]`%), Neotropics (`r prop_success_dat_yr$prop_success_diff[4]`%) and Australasia (`r prop_success_dat_yr$prop_success_diff[5]`%).

The total area that experienced loss of connectivity was `r format(cc_decrease_area,big.mark=",", trim=TRUE)` km^2^, or `r signif((cc_decrease_area / total_ccc_area) * 100, 3)`% of total tropical forest area. Increases in climate connectivity were also observed, although this affected only `r format(cc_increase_area,big.mark=",", trim=TRUE)` km^2^ (`r signif((cc_increase_area / total_ccc_area) * 100, 3)`%) of total forest area. Loss of connected area did not differ by realm (`r cc_loss_results$ref[cc_loss_results$EV == "realm"]`) or past tree cover (`r cc_loss_results$ref[cc_loss_results$EV == "tc_2000"]`), but did increase with increasing area of forest loss (`r cc_loss_results$ref[cc_loss_results$EV == "tc_loss"]`). The non-linearity of this latter result suggests that the loss of connected area accelerates beyond a threshold loss of forested area.

(ref:cap-5-3) The proportion of total forested area in each land mass that lost climate connectivity between 2000 and 2012, with increasing area of forest loss and across different biogeographic realms (orange = Afrotropics, blue = Australasia, green = Indomalaya, yellow = Neotropics and pink = Oceania). Points correspond to raw data, with point size indicating the number of observations at that location. Fitted lines derive from model predictions. Note that confidence intervals are omitted because standard error calculation for new predicted values is not currently supported in the gamlss package.

```{r fig-5-3, fig.cap= "(ref:cap-5-3)", fig.height=10/2.54}
ggplot(cc_loss_dat$tc_loss_pred, 
       aes(x = expm1(tc_loss_log1p),
           y = prop_decrease_cc * 100,
           colour = realm)) +
    geom_count(data = region_ccc_inc,
               alpha = 0.7) +
    geom_line()+
    xlab(paste("Area of forest loss (km","\U00B2",")",sep="")) +
    ylab("Proportion area losing connectivity (%)") +
    theme_bw() +
    theme(axis.text = element_text(size = text_size),
          axis.title = element_text(size = title_size),
          legend.direction = "horizontal", 
          legend.position = "top",
          legend.text = element_text(size = text_size),
          legend.box = "vertical",
          legend.spacing = unit(0, "cm"),
          panel.grid = element_blank()) +
    scale_y_continuous(breaks = seq(0,100,10)) +
    scale_x_continuous(trans="log1p",
                       breaks = trans_breaks("log1p", function(x) expm1(x)),
                       labels = trans_format("log1p", math_format())) +
    guides(colour = guide_legend(title = NULL),
           size = guide_legend(title = NULL, nrow = 1)) +
    scale_colour_manual(values = cbpal2)
```

(ref:cap-C-1) The proportion of total forested area in each land mass that lost climate connectivity between 2000 and 2012, according to biogeographic realm and forested area in the year 2000. Points correspond to raw data and fitted lines derive from model predictions. Note that confidence intervals are omitted because standard error calculation for new predicted values is not currently supported in the gamlss package.

```{r fig-C-1, fig.cap= "(ref:cap-C-1)", fig.height= 9/2.54}
ggplot(cc_loss_dat$tc_2000_pred, 
       aes(x = tc_2000,
           y = prop_decrease_cc * 100,
           colour = realm)) +
    geom_point(data = region_ccc_inc) +
    geom_line() +
    xlab(paste("Forested area in 2000 (km","\U00B2",")",sep="")) +
    ylab("Proportion area losing connectivity (%)") +
    theme_bw() +
    theme(axis.text = element_text(size = text_size),
          axis.title = element_text(size = title_size),
          legend.text = element_text(size = text_size),
          legend.title = element_blank(),
          legend.position = "top",
          # legend.position = c(0.1, 0.8),
          panel.grid = element_blank()) +
    scale_y_continuous(breaks = seq(0,100,10))+
    scale_colour_manual(values = cbpal2)
```

## Discussion

Loss of forest cover is extensive in the tropics [@hansen_high-resolution_2013; @lewis_increasing_2015] and causes widespread and accelerating fragmentation of remaining habitat [@taubert_global_2018]. Simultaneously, climate change poses an increasing risk to thermally restricted forest specialists [@tewksbury_putting_2008]; the ability of such species to track climate will be important in determining their risk of extinction under climate change. We found that, across much of the tropics, current forest cover is already insufficient to facilitate range shifts to future climate analogues. Furthermore, the relationship between loss of forest cover and loss of climate connectivity is such that the problem is likely to magnify as forest loss continues.

### Current state of climate connectivity

Pan-tropically, average climate connectivity in 2012 was `r signif(median(patches$cc[patches$year == "2012"]),3)`&deg;C (\autoref{fig:fig-5-1}a). In other words, in the average scenario, if a species were only limited by climate connectivity and their range shifted as far along temperature gradients as permitted by current forest cover, they would still experience `r -signif(median(patches$cc[patches$year == "2012"]),3)`&deg;C degrees of warming under projected future climate change. Although average climate connectivity was unsuccessful (<0), and was lowest in the Neotropics (`r median_cc_dat_2012$median_cc[1]`&deg;C; \autoref{fig:fig-5-2}a), the total area of forest that achieved successful climate connectivity (&ge;0) was more than half of the total forested area (`r signif((success_area / total_area) * 100, 3)`%), and was second highest for the Neotropics (`r prop_success_dat_2012$prop_success[4]`%; \autoref{fig:fig-5-2}b). This discrepancy is likely due to the fact that the areas of tropical forest that were successfully connected -- e.g. western Amazon and parts of New Guinea -- are large, contiguous areas of forest (\autoref{fig:fig-5-1}a) that connect warmer lowland regions to cool uplands [@lawler_projected_2013; @littlefield_connecting_2017]. Similar patterns were observed by @mcguire_achieving_2016 in the contiguous United States, where only 41% of natural land was found to achieve successful climate connectivity. 

Regions with high forest cover but little spatial variation in climate (e.g. North-east Amazon) had relatively low climate connectivity. Climate connectivity was also low in the Afrotropics and Indomalaya (\autoref{fig:fig-5-2}a and \autoref{fig:fig-5-2}b), which likely reflects the severe loss and fragmentation of lowland rainforests in these regions [@lewis_increasing_2015; @haddad_habitat_2015]. The high climate connectivity of Oceania should be interpreted with caution, because the low number and small area of Oceanian land masses results in large confidence intervals (\autoref{fig:fig-5-2}a and \autoref{fig:fig-5-2}b. 

### Change in climate connectivity

In only 12 years, change of climate connectivity was widespread -- `r round((cc_decrease_area / total_ccc_area) * 100, 1)`% of cells forested in 2000 or 2012 experienced loss of climate connectivity, compared to just `r round((cc_increase_area / total_ccc_area) * 100, 1)`% that experienced gains. Loss of connectivity increased nonlinearly with loss of forest area. The implication of this finding is that beyond a certain threshold of forest loss, additional deforestation causes increasingly large loss of climate connectivity. A comparable effect is seen in the number and size of forest fragments created by forest loss [@taubert_global_2018]. It is likely that low levels of forest loss reduce redundancy by removing potential links to future climate analogues, until a critical point is reached beyond which additional forest loss severs the link completely, and climate connectivity falls below zero. The creation of climate corridors may serve to reinstate these links, giving disproportionate increases of climate connectivity for a given increase in forest area [@mcguire_achieving_2016; @littlefield_connecting_2017]. This may be all the more necessary since hotspots of poor climate connectivity (\autoref{fig:fig-5-1}a) and connectivity loss (\autoref{fig:fig-5-1}b) frequently appear to coincide with hotspots of species' vulnerability to climate change [@pacifici_framework_2018; @pacifici_assessing_2015]. That said, habitat corridors are not appropriate for all taxa and locations [@early_analysis_2011; @lees_conservation_2008].

We expected regions with low forest area in 2000 to be more susceptible to loss of climate connectivity, because they are less likely to have redundant links to analogous future climates. However, to retain deforested and reforested cells within our analyses it was necessary to quantify connectivity change as a change of state -- either from being connected to not connected (but still forested), or from forest to non-forest. We also summarised our measures of climate connectivity and forest cover across land masses. Both of these factors invariably coarsened our variables and would potentially make it more difficult to detect subtle relationships. Additionally, despite the short time span there was extensive land-use change in the tropics during this period [@hansen_high-resolution_2013], which may have blurred the relationship between the start and end point of pan-tropical climate connectivity.

### Caveats and limitations

The climate connectivity metric used here is a measure of the physical potential for thermally restricted groups of species to track climate through near-continuous forest cover [cf. @mcguire_achieving_2016]. We do not incorporate any species-specific information, but note that many other factors will affect both the need and capacity for species to shift their ranges. For example, species can adapt *in situ* via phenotypic plasticity, genetic adaptation or exploitation of local climate refugia [@parmesan_ecological_2006; @hannah_fine-grain_2014; @socolar_phenological_2017]. Dispersal limits could preclude species from tracking their preferred climate even where high climate connectivity exists [@schloss_dispersal_2012], while some species may be capable of traversing greater distances through non-forest than we have allowed in our approach, and current patterns of forest cover will themselves change through time.  

We focus on Mean Annual Temperature to create climate-partitioned forest patches, but note that other climate variables - particularly precipitation and heatwaves - are also important in determining the climatic niche of any given species. Unfortunately, projections of future precipitation under climate change remain highly uncertain [@ipcc_climate_2013; @corlett_climate_2012], and are also highly variable in space, both of which make it unclear the gradient that species would have to follow to avoid deleterious changes in precipitation. 

The breadth of our study enabled us to determine broad trends and patterns across the most biodiverse terrestrial region. However, to achieve such breadth requires that assumptions and simplifications are made. For regional and local scales, our results are best interpreted as a signpost to locations that appear to deviate from trends at a pan-tropical scale, and would therefore benefit from further, targeted investigation at a finer spatial scale, potentially incorporating species-specific information appropriate to the questions of interest [e.g. @martensen_spatio-temporal_2017]. Violations of our assumptions in particular regions would render our estimates of climate connectivity less accurate in those places. Overall, however, our focus is on broad trends in climate connectivity, and therefore regional discrepancies will likely have limited impact on our overall conclusions. Our study is the first to quantify climate connectivity pan-tropically and over time. This and other, complementary studies [@mcguire_achieving_2016; @littlefield_connecting_2017; @lawler_projected_2013] will be greatly enhanced by continuing developments in global, remotely sensed datasets [@sanchez-azofeifa_twenty-first_2017].

### Summary

The loss of connectivity between species' current distributions and analogous future climates represents a stark way in which land-use change and climate change may negatively interact. To maximise species' ability to respond to climate change, it is necessary to understand how current land cover facilitates range shifts, and how patterns of climate connectivity have changed over time. We show that currently much of the tropics has a limited capacity to connect species to climate analogues. We suggest that landscape planning for climate resilience should firstly endeavour to limit the extent of forest loss, via land-sparing approaches, carbon-based payments for ecosystem services, and development on existing, deforested land. Where opportunities arise to reforest or protect existing forest cover, disproportionate gains may come from focusing on connecting forest along climate gradients.

## Acknowledgements

We thank Jenny L. McGuire for making her code publicly available, and for providing us with additional help and guidance. Thanks also to Felix K. S. Lim, Philip J. Platts and Sarah A. Scriven for helpful discussions. R.A.S. was funded by a NERC studentship through the ACCE (Adapting to the Challenges of a Changing Environment) Doctoral Training Partnership (Grant No. NE/L002450/1). Data available from The Environmental Information Data Centre (EIDC) [PENDING REF]. Python code to calculate climate connectivity can be downloaded from GitHub (https://github.com/rasenior/ClimateConnectivity).


