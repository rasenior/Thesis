
```{r knitr-setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = FALSE,message = FALSE,error = FALSE, warning = FALSE, 
                      fig.width = 16.6/2.54, fig.height = 9/2.54, dpi = 800, 
                      fig.path = "./output/", fig.align='center', fig.pos = 'H')
```

```{r setup-other, include = FALSE}
library(knitr)
library(ggplot2)
library(scales)
library(dplyr)
library(cowplot)
library(extrafont)
library(xtable)
library(viridis)
library(rgdal)
library(rgeos)

# Plotting parameters
text_size <- 6
title_size <- 8
lab_size <- 7

# Projections
wgs84 <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
cea <- "+proj=cea +lon_0=0 +lat_ts=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"

# Colourblind-friendly palette
cbpal1 <- viridis(4, option = "D")
cbpal2 <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#CC79A7", "#D55E00","#0072B2")

# Function for extracting legend
g_legend<-function(a.gplot){
    tmp <- ggplot_gtable(ggplot_build(a.gplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)}

# Significance val
get_signif <- function(p_val){
    signif_level <- 
        ifelse(p_val >0.05, paste("= ", signif(p_val, 3), sep = ""),
               ifelse(p_val <= 0.05 & p_val >0.01, "< 0.05",
                      ifelse(p_val <= 0.01 & p_val >0.001, "< 0.01", 
                             "< 0.001")))
    return(signif_level)
}

relevel_df <- function(df){
    # Relevel dataset name
    df[,"df_name"] <- 
        factor(df[,"df_name"], 
               levels = c(c("full_rcp85",
                            "full_rcp26"),
                          c("plantations-w_10_sep_2", 
                            "plantations-wo_10_sep_2"),
                          paste("full_area_", 
                                c(1,5,10,25,100), 
                                "_sep_2", 
                                sep = "")),
               labels = c(c("RCP8.5", 
                            "RCP2.6"),
                          c("With plantations",
                            "Without plantations"),
                          paste("Min. patch size = ", 
                                c(1,5,10,25,100), 
                                " km", 
                                "\U00B2", sep = "")))
    # Relevel realm
    if("realm" %in% names(df)){
        df[,"realm"] <- factor(df[,"realm"],
                               levels = c("Neotropics",
                                          "Afrotropics",
                                          "Indomalaya",
                                          "Australasia",
                                          "Oceania")) 
        df <- arrange(df, df_name, realm)
    }else df <- arrange(df, df_name)
    
    return(df)
}

sort_results <- function(dat, RV, Df, stat, stat_val,P, fig_refs){
    dat <- 
        data.frame(dat) %>% 
        mutate(RV = RV,
               Df = Df,
               EV = dropped_EV,
               stat = stat,
               stat_val = dat[,stat_val],
               P = dat[,P],
               p_val = get_signif(P),
               fig_ref = fig_refs) %>%
        filter(!(is.na(p_val))) %>% 
        select(df_name, RV, EV, Df, stat, stat_val, P, p_val, fig_ref) %>% 
        mutate(ref = paste(stat, " = ", signif(stat_val,3), ", ",
                           "P ", p_val, 
                           "; ", fig_ref,
                           sep = "")) %>% 
        relevel_df()
    return(dat)
}
```

```{r raw-dat, include = FALSE}
region_cc <- 
    readRDS("data/ch5/rcps/rcp85/region_cc.Rds") %>% 
    mutate(prop_fail = (fail_patch_area / sum_patch_area) * 100,
           prop_success = 100 - prop_fail)
region_ccc <- 
    readRDS("data/ch5/rcps/rcp85/region_ccc.Rds") %>% 
    mutate(prop_decrease_cc = (area_decrease_cc / sum_patch_area) * 100,
           tc_loss_log1p = log1p(loss))

# Cc polygons
load("data/ch5/rcps/rcp85/map_dat_cc.Rdata")
# Ccc polygons
load("data/ch5/rcps/rcp85/map_dat_ccc.Rdata")

# Total successful area
success_area <- sum(region_cc$success_patch_area[region_cc$year == "2012"])
fail_area <- sum(region_cc$fail_patch_area[region_cc$year == "2012"])
total_area <- sum(region_cc$sum_patch_area[region_cc$year == "2012"])

# Total cc loss area
cc_decrease_area <- sum(region_ccc$area_decrease_cc)
cc_increase_area <- sum(region_ccc$area_increase_cc)
total_ccc_area <- sum(region_ccc$sum_patch_area)

# Read in SOM data
load("data/ch5/som_dat.Rdata")
```

```{r median-cc-dat, include = FALSE}

load("data/ch5/models/rcps/median_cc.Rdata")
median_cc_dat <- median_cc_dat[median_cc_dat$df_name == "full_rcp85",]
median_cc_results <- median_cc_results$full_rcp85.results

# Sort results
median_cc_interaction <-
    sort_results(dat = median_cc_results$interaction_results, 
                 RV = "median_cc", 
                 Df = "Df",
                 stat =  "F",
                 stat_val = "F",
                 P =  "Pr(>F)",
                 fig_refs = "\\autoref{fig:fig-5-2}a")
median_cc_results <- 
    sort_results(dat = median_cc_results$main_results, 
                 RV = "median_cc", 
                 Df = "Df",
                 stat =  "F",
                 stat_val = "F",
                 P =  "Pr(>F)",
                 fig_refs = "\\autoref{fig:fig-5-2}a")

# Sort predicted values
median_cc_dat <-
    median_cc_dat %>% 
    relevel_df() %>% 
    mutate(median_cc = signif(median_cc,2)) %>% 
    # Rank by median cc within dataset > realm > year
    arrange(df_name, realm, year, median_cc) %>% 
    group_by(df_name, year) %>% 
    mutate(rank = rank(median_cc, ties.method = "first")) %>% 
    as.data.frame()
```

```{r prop_fail_dat, include = FALSE}
load("data/ch5/models/rcps/prop_fail.Rdata")
prop_fail_dat <- prop_fail_dat[prop_fail_dat$df_name == "full_rcp85",]
prop_fail_results <- prop_fail_results$full_rcp85.results

# Sort results
prop_fail_interaction <-
    sort_results(dat = prop_fail_results$interaction_results, 
                 RV = "prop_fail", 
                 Df = "Df",
                 stat =  "F",
                 stat_val = "F",
                 P =  "Pr(>F)",
                 fig_refs = "\\autoref{fig:fig-5-2}b")
prop_fail_results <- 
    sort_results(dat = prop_fail_results$main_results, 
                 RV = "prop_fail", 
                 Df = "Df",
                 stat =  "F",
                 stat_val = "F",
                 P =  "Pr(>F)",
                 fig_refs = "\\autoref{fig:fig-5-2}b")

# Sort predicted values
prop_fail_dat <-
    prop_fail_dat %>% 
    relevel_df() %>% 
    mutate(prop_fail = signif(prop_fail * 100,3)) %>% 
    # Rank by median cc within dataset > realm > year
    arrange(df_name, realm, year, prop_fail) %>% 
    group_by(df_name, year) %>% 
    mutate(rank = rank(-prop_fail, ties.method = "first")) %>% 
    as.data.frame()

prop_fail_dat_yr <-
    prop_fail_dat %>% 
    group_by(realm) %>% 
    summarise(prop_fail_diff = diff(prop_fail)) %>% 
    arrange(desc(prop_fail_diff))

model_fail_area <- 
    (median(filter(prop_fail_dat, year == "2012") 
            %>% .[,"prop_fail"])/100) * total_area
```

```{r cc-loss-dat, include = FALSE}
load("data/ch5/models/rcps/cc_loss.Rdata")
cc_loss_dat <- cc_loss_dat[cc_loss_dat$df_name == "full_rcp85",]
cc_loss_results <- cc_loss_results$full_rcp85.results

# Sort results
cc_loss_results <- 
    sort_results(dat = cc_loss_results$main_results, 
                 RV = "cc_loss_area", 
                 Df = "Df",
                 stat =  "F",
                 stat_val = "F",
                 P =  "Pr(>F)",
                 fig_refs = "\\autoref{fig:fig-5-3}")

# Sort predicted values
cc_loss_dat <-
    cc_loss_dat %>% 
    relevel_df() %>% 
    mutate(prop_decrease_cc = signif(prop_decrease_cc * 100,3),
           lwr = lwr * 100,
           upr = upr * 100)

# Sumamrise SOM results
prop_fail_dat_som3 <- 
    group_by(prop_fail_dat_som3, year, df_name) %>% 
    summarise(median_prop_fail = 100 - median(prop_fail))

```

```{r prep-4-plotting, include = FALSE}

# Get rid of NAs
patches <- na.omit(patches)
ccc_polys <- na.omit(ccc_polys)

# Reduce patch polys to 2012 only
patches <- patches[patches$year == "2012",]

# Add region info
ccc_polys$year <- "2012 - 2000"

# Order Oceania regions by area & assign name
oceania <- 
    filter(patches,
           realm == "Oceania",
           !(duplicated(region)))
oceania <-
    region_cc[match(oceania$region, region_cc$region),] %>%
    select(region, region_area) %>% 
    arrange(desc(region_area)) %>% 
    mutate(region_name = c("Viti Levu (Fiji)",
                           "Hawai'i (Hawaii)",
                           "Vanua Levu (Fiji)",
                           "O'ahu (Hawaii)",
                           "Kauai (Hawaii)",
                           "Kadavu Island (Fiji)",
                           "Taveuni Island (Fiji)",
                           "Babeldaob (Palau)"))

#   region region_area
# 1 p25236  10651.6281 = Viti Levu (Fiji)
# 2 p10780  10431.1066 = Hawai'i (Hawaii)
# 3 p22626   5689.2545 = Vanua Levu (Fiji)
# 4  p3617   1556.0912 = O'ahu (Hawaii)
# 5 p21905   1438.5133 = Kauai (Hawaii)
# 6  p2145    439.6505 = Kadavu Island (Fiji)
# 7 p15596    435.9987 = Taveuni Island (Fiji)
# 8 p21477    365.1751 = Babeldaob (Palau)

# Add region name to polygon layers
boundaries$region_name <- 
    oceania$region_name[match(boundaries$id, oceania$region)]
patches$region_name <- 
    oceania$region_name[match(patches$region, oceania$region)]
ccc_polys$region_name <- 
    oceania$region_name[match(ccc_polys$region, oceania$region)]

# Remove regions < 300 km^2
boundaries <-
    filter(boundaries,
           region_area >= 300,
           # Also remove non-tropical realms
           realm %in% c("Neotropics",
                        "Afrotropics",
                        "Indomalaya",
                        "Australasia",
                        "Oceania"),
           # Also reduce to regions that actually have connectivity data
           id %in% patches$region)
patches <- 
    patches %>% 
    filter(region_area >= 300,
           !(is.na(realm)))
ccc_polys <- 
    ccc_polys %>% 
    filter(region_area >= 300,
           !(is.na(realm)))

# Define function to adjust lat/long for Oceania
adj_oceania <- function(df, 
                        hawaii_adj = list(),
                        palau_adj = list()
){
    # Adjust Hawaii
    df[grepl("Hawaii", df[,"region_name"]), "long"] <-
        df[grepl("Hawaii", df[,"region_name"]), "long"] + hawaii_adj$long
    df[grepl("Hawaii", df[,"region_name"]), "lat"] <-
        df[grepl("Hawaii", df[,"region_name"]), "lat"] + hawaii_adj$lat
    
    # Adjust Palau
    df[grepl("Palau", df[,"region_name"]), "long"] <-
        df[grepl("Palau", df[,"region_name"]), "long"] + palau_adj$long
    df[grepl("Palau", df[,"region_name"]), "lat"] <-
        df[grepl("Palau", df[,"region_name"]), "lat"] + palau_adj$lat
    
    # Return
    return(df)
}

# Shift Hawaii & Palau polygons
boundaries <- 
    adj_oceania(df = boundaries,
                # Max long (180 degrees) plus extra adjustment
                hawaii_adj = (list(long = 20037507.067162 + 17900000, 
                                   lat = - 3700000)),
                palau_adj = (list(long = 4900000,
                                  lat = - 2300000)))
patches <- 
    adj_oceania(df = patches,
                # Max long (180 degrees) plus extra adjustment
                hawaii_adj = (list(long = 20037507.067162 + 17900000, 
                                   lat = - 3700000)),
                palau_adj = (list(long = 4900000,
                                  lat = - 2300000)))
ccc_polys <- 
    adj_oceania(df = ccc_polys,
                # Max long (180 degrees) plus extra adjustment
                hawaii_adj = (list(long = 20037507.067162 + 17900000, 
                                   lat = - 3700000)),
                palau_adj = (list(long = 4900000,
                                  lat = - 2300000)))

# Define extras for Oceania facet
oceania_labs <- 
    data.frame(realm = "Oceania",
               lab = c("Palau",
                       "Hawaii",
                       "Fiji"),
               long = c(19850000,
                        20450000,
                        19850000),
               lat = c(rep(-1600000,2),
                       -1720000),
               vline = 20090000,
               hline = -1680000)

# Relevel realm
patches$realm <- factor(patches$realm,
                        levels = c("Neotropics",
                                   "Afrotropics",
                                   "Indomalaya",
                                   "Australasia",
                                   "Oceania"))
ccc_polys$realm <- factor(ccc_polys$realm,
                          levels = c("Neotropics",
                                     "Afrotropics",
                                     "Indomalaya",
                                     "Australasia",
                                     "Oceania"))
```

# Global loss of climate connectivity in tropical forests {#ch5}

\begin{figure}[!htb]
\centering
\includegraphics[width=15cm]{pics/landscape1.jpg}
\caption*{Mixed use tropical landscape in Bali.}
\end{figure}

This chapter is currently in preparation for submission to *Nature* as:

**Senior RA, Hill JK, Edwards DP. Global loss of climate connectivity in tropical forests. In prep.**

\pagebreak

## Abstract

Range shifts are a crucial mechanism enabling species to avoid extinction under climate change [@chen_rapid_2011; @parmesan_ecological_2006]. The majority of terrestrial biodiversity is concentrated in the tropics [@jenkins_global_2013], including species considered most vulnerable to climate warming [@tewksbury_putting_2008], but extensive and ongoing deforestation of tropical forests is likely to impede range shifts [@taubert_global_2018; @mcguire_achieving_2016]. We conduct the first global assessment of the potential for tropical species to reach analogous future climates -- so-called 'climate connectivity' -- and empirically test how this has changed in response to deforestation between 2000 and 2012. We find that over `r signif(median(filter(prop_fail_dat, year == "2012") %>% .[,"prop_fail"]), 2)`% of tropical forest (~ 7M km^2^) is already incapable of facilitating range shifts to analogous future climates. In just 12 years over `r signif((cc_decrease_area / total_ccc_area) * 100, 2)`% of tropical forest experienced a loss of climate connectivity, with non-linear declines in connectivity as forest loss increased. On average, if species' ranges shift as far down climate gradients as permitted by existing forest connectivity, by 2070 organisms would still experience `r -signif(median(filter(median_cc_dat_som3, year == "2012", df_name == "RCP2.6") %>% as.data.frame() %>% .[,"median_cc"]),2)`&deg;C of warming under the least severe climate warming scenario, up to `r -signif(median(filter(median_cc_dat_som3, year == "2012", df_name == "RCP8.5") %>% as.data.frame() %>% .[,"median_cc"]),2)`&deg;C warming for the most severe scenario. Limiting further forest loss and focusing the global restoration agenda towards creating climate corridors are global priorities for improving resilience of tropical forests under climate change.

## Main text

Globally, in paleo-ecological records and under modern climate change, species have moved polewards or upwards to avoid extinction under climate warming [@parmesan_ecological_2006; @chen_rapid_2011]. Land-use change increasingly impedes range shifts by fragmenting natural habitat [@tucker_moving_2018]. This is of particular concern in the tropics, where most remaining terrestrial biodiversity is harboured [@jenkins_global_2013] and where most new agricultural land will be sourced [@lewis_increasing_2015]. Additionally, the tropics will experience the earliest appearance of novel climatic conditions [@mora_projected_2013], for which many tropical species will be unequipped because of their narrow thermal limits [@tewksbury_putting_2008] and limited dispersal relative to rates of climate change [@opdam_climate_2004; @loarie_velocity_2009]. 

The potential for species to shift their range in response to climate change depends both on the future availability of suitable habitat with an analogous climate, and the connectivity between that habitat and the species' current distribution [@littlefield_connecting_2017]. Many studies have addressed these factors individually, but few have integrated them to quantify the connectedness of natural areas to future climate analogues -- hereafter: 'climate connectivity' [@nunez_connectivity_2013]. Of those that do [@lawler_projected_2013; @mcguire_achieving_2016; @littlefield_connecting_2017], none have applied the approach pantropically or considered how climate connectivity has changed over time.

Here we combine a high-resolution forest cover layer [@hansen_high-resolution_2013] with current and projected future Mean Annual Temperature [@hijmans_very_2005] (hereafter: temperature), to quantify across the tropics: (1) the potential for species to reach analogous future climate within existing forest cover, and (2) the change in this measure of climate connectivity from 2000 to 2012. Climate connectivity was calculated based on the method of @mcguire_achieving_2016, whereby natural land cover -- here defined as cells with more than 50% forest cover [@hansen_high-resolution_2013] -- was partitioned into patches based on current temperature (~1950-2000; WorldClim v1.4), and each forest patch traced to the coolest patch that could be reached by traversing a gradient of hotter to cooler adjacent patches. All patches were then assigned mean future temperature for the year 2070 (average for 2061-2080), derived from the HadGEM2-AO general circulation model [@ipcc_climate_2013] and Representative Concentration Pathway (RCP) 8.5, which is the most severe ('business-as-usual') IPCC scenario. To capture the extent to which forest cover enables species to reach a place that, under future climate warming, is the same as or cooler than their current location, climate connectivity was calculated as the current temperature of each patch minus the future temperature of its designated destination patch. Negative values indicate that the coolest reachable forest is still warmer under climate change than the current temperature, and inhabitant organisms would fail to reach an analogous climate under projected warming.

We found that, on average, if tropical species were only limited by climate connectivity and their range shifted as far along temperature gradients as permitted by current forest cover, they would still experience `r -signif(median(median_cc_dat %>% filter(year == "2012") %>%  .[,"median_cc"]),2)`&deg;C of warming under projected future climate change (median value across all realms; \autoref{fig:fig-5-1}a). The average climate connectivity of discrete land masses varied by biogeographic realm (`r median_cc_results$ref[median_cc_results$EV == "realm"]`) with the Neotropics and Afrotropics the least well connected, resulting in unavoidable warming of `r median_cc_dat %>% filter(year == "2012", realm == "Neotropics") %>% .[,"median_cc"]`&deg;C and `r median_cc_dat %>% filter(year == "2012", realm == "Afrotropics") %>% .[,"median_cc"]`&deg;C, respectively. Range-shifting species in Indomalaya, Australasia and Oceania would also fail to reach analogous temperatures, experiencing warming of `r median_cc_dat %>% filter(year == "2012", realm == "Indomalaya") %>% .[,"median_cc"]`, `r median_cc_dat %>% filter(year == "2012", realm == "Australasia") %>% .[,"median_cc"]` and `r median_cc_dat %>% filter(year == "2012", realm == "Oceania") %>% .[,"median_cc"]`&deg;C, respectively. This suggests that the average tropical forest, for any given realm, is not sufficiently connected along a temperature gradient to enable species to avoid climate change by shifting their distribution.

```{r fig-5-1-prep, include = FALSE}
p1a <-
    ggplot() +
    geom_polygon(data = boundaries,
                 aes(x = long,
                     y = lat,
                     group = group),
                 fill = "grey20") +
    # Line to delineate W/E hemisphere
    geom_vline(data = oceania_labs,
               aes(xintercept = vline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20") +
    # Line to delineate N/S hemisphere
    geom_hline(data = oceania_labs,
               aes(yintercept = hline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20")+
    # Oceania labels
    geom_text(data = oceania_labs,
              aes(x = long,
                  y = lat,
                  label = lab),
              size = 2) +
    # Cc polygons
    geom_polygon(data = patches,
                 aes(x = long,
                     y = lat,
                     group = group,
                     fill = cc)) +
    facet_wrap( ~ realm,
                scales = "free",
                nrow = 1) +
    theme_bw() +
    ylab("2012") +
    theme(axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.ticks = element_blank(),
          plot.margin = margin(1, 2, 1, 2),
          panel.background = element_rect(fill = "darkseagreen3"),
          panel.grid = element_blank(),
          panel.spacing.x = unit(-0.2, units = "lines"),
          panel.spacing.y = unit(0, units = "lines"),
          strip.background = element_blank(),
          strip.text = element_text(size = title_size,
                                    hjust = 0.5),
          legend.text = element_text(size = text_size),
          legend.title = element_text(size = text_size),
          legend.box.spacing = unit(0,"cm"),
          legend.box.margin = margin(0,0,0,2),
          legend.position = "bottom") +
    # scale_x_continuous(expand = c(0, 0))+
    scale_y_continuous(expand = c(0.012, 0))+
    coord_equal(ratio=1) +
    scale_fill_gradient2(low = "red4",
                         mid = "beige",
                         high = "dodgerblue", 
                         breaks = seq(-4, 8, 2),
                         limits = c(-4,8)) +
    guides(fill = guide_colourbar(raster = FALSE, 
                                  barheight = unit(3, units = "mm"),
                                  barwidth = unit(2, units = "cm"),
                                  direction = "horizontal",
                                  title.vjust = 0,
                                  title.position = "left",
                                  title = expression("Climate connectivity ("*degree*"C)")))


p1b <-
    ggplot() +
    # Realms
    geom_polygon(data = boundaries,
                 aes(x = long,
                     y = lat,
                     group = group),
                 fill = "grey20") +
    # Line to delineate W/E hemisphere
    geom_vline(data = oceania_labs,
               aes(xintercept = vline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20") +
    # Line to delineate N/S hemisphere
    geom_hline(data = oceania_labs,
               aes(yintercept = hline),
               linetype = "dashed",
               size = 0.2,
               colour = "grey20")+
    # Oceania labels
    geom_text(data = oceania_labs,
              aes(x = long,
                  y = lat,
                  label = lab),
              size = 2) +
    # Cc polygons
    geom_polygon(data = ccc_polys,
                 aes(x = long,
                     y = lat,
                     group = group,
                     fill = cc_change)) +
    facet_wrap( ~ realm,
                scales = "free",
                nrow = 1) +
    theme_bw() +
    ylab("2012 - 2000") +
    theme(axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.ticks = element_blank(),
          plot.margin = margin(1, 2, 1, 2),
          panel.background = element_rect(fill = "darkseagreen3"),
          panel.grid = element_blank(),
          panel.spacing.x = unit(-0.2, units = "lines"),
          panel.spacing.y = unit(0, units = "lines"),
          strip.background = element_blank(),
          strip.text = element_text(size = title_size,
                                    hjust = 0.5),
          legend.text = element_text(size = text_size),
          legend.title = element_text(size = text_size),
          legend.box.spacing = unit(0,"cm"),
          legend.box.margin = margin(0,0,0,0),
          legend.position = "bottom") +
    # scale_x_continuous(expand = c(0, 0))+
    scale_y_continuous(expand = c(0.012, 0))+
    coord_equal(ratio=1) +
    scale_fill_gradient2(low = "red4",
                         mid = "beige",
                         high = "dodgerblue",
                         breaks = seq(-10, 10, 5),
                         limits = c(-10,10)) +
    guides(fill = guide_colourbar(raster = FALSE, 
                                  barheight = unit(3, units = "mm"),
                                  barwidth = unit(2, units = "cm"),
                                  direction = "horizontal",
                                  title.vjust = 0,
                                  title.position = "left",
                                  title = expression(Delta~"Climate connectivity ("*degree*"C)")))

p1 <-
    plot_grid(p1a, p1b, 
              nrow = 2, ncol = 1,
              align = "hv", 
              labels = c("(a)", "(b)"), 
              label_size = lab_size)

ggsave(plot = p1, filename = "figs/fig5.1.pdf", width = 16.6, height = 8, units = "cm")
```

(ref:cap-5-1) Climate connectivity in 2012 (a) and change in climate connectivity from 2000 to 2012 (b). Positive values (blue) indicate successful climate connectivity in panel (a), or a gain of connectivity in panel (b). Negative values (red) indicate unsuccessful climate connectivity in panel (a), or a loss of connectivity in panel (b). To aid visualisation we have shifted and magnified land masses in Oceania.

```{r fig-5-1, fig.cap= "(ref:cap-5-1)", fig.width = 18.3/2.54, fig.height = 8/2.54}
p1
```

Overall, `r median(prop_fail_dat %>% filter(year == "2012") %>%  .[,"prop_fail"])`% of tropical forest area failed to achieve successful climate connectivity (&ge; 0; median value across realms), whereby species' range shifts within existing forest cover could circumvent climate warming. This is comparable to the 59% observed in the continental United States by @mcguire_achieving_2016, and is all the more concerning because of the greater numbers of climate-vulnerable species with narrow thermal limits. Variation across biogeographic realms (`r prop_fail_results$ref[prop_fail_results$EV == "realm"]`) showed slightly different patterns than for average climate connectivity. Indomalaya was the least successful realm with `r prop_fail_dat %>% filter(year == "2012", realm == "Indomalaya") %>%  .[,"prop_fail"]`% of its forested area failing to connect to climate analogues, followed by the Neotropics (`r prop_fail_dat %>% filter(year == "2012", realm == "Neotropics") %>%  .[,"prop_fail"]`%), Oceania (`r prop_fail_dat %>% filter(year == "2012", realm == "Oceania") %>%  .[,"prop_fail"]`%), Afrotropics (`r prop_fail_dat %>% filter(year == "2012", realm == "Afrotropics") %>%  .[,"prop_fail"]`%), and Australasia (`r prop_fail_dat %>% filter(year == "2012", realm == "Australasia") %>%  .[,"prop_fail"]`%). As found in previous studies [@lawler_projected_2013; @littlefield_connecting_2017], regions with large, contiguous forest patches connecting warmer lowland regions to cool uplands, such as the western Amazon, Congo Basin and parts of New Guinea (\autoref{fig:fig-5-1}a), can compensate somewhat for low average climate connectivity. That said, in these locations the total path distance from source to target patch was often substantial -- up to `r format(round(max(region_cc$max_dist),0), big.mark = ",")` km for one source patch in the Neotropics -- and this does not account for biogeographic barriers such as major rivers. Climate connectivity was consistently low for regions with severe and extensive loss of lowland rainforests, such as Indochina, Brazilian Atlantic forest and West Africa [@lewis_increasing_2015; @haddad_habitat_2015]. 

(ref:cap-5-2) Climate connectivity of land masses in different biogeographic realms in the year 2000 (green) and 2012 (purple). Panel (a) shows results for median climate connectivity, with the dashed line indicating zero climate connectivity, at and above which successful climate connectivity is achieved. Panel (b) shows results for the proportion of total forested area that fails to achieve successful climate connectivity. Solid points are model-predicted values with 95% confidence intervals. Raw data are plotted in the background as semi-transparent points.

```{r fig-5-2, fig.cap= "(ref:cap-5-2)", fig.width = 18.3/2.54, fig.height = 8/2.54}

p2a <-
    ggplot(data = median_cc_dat, 
           aes(x = year,
               y = median_cc,
               colour = year)) +
    geom_hline(yintercept = 0, 
               linetype = "dashed",
               size = 0.8) +
    geom_point(position = position_dodge(width = 0.5),
               alpha = 0) +
    geom_rect(aes(xmin = -Inf,
                  xmax = Inf,
                  ymin = -Inf,
                  ymax = 0,
                  colour = NULL),
              fill = cbpal2[5],
              alpha = 0.05) +
    geom_rect(aes(xmin = -Inf,
                  xmax = Inf,
                  ymin = 0,
                  ymax = Inf,
                  colour = NULL),
              fill = cbpal2[7],
              alpha = 0.05) +
    geom_jitter(data = region_cc,
                aes(x = year,
                    y = median_cc,
                    colour = year),
                alpha = 0.2,
                shape = 16,
                size= 1) +
    geom_point(position = position_dodge(width = 0.5)) +
    geom_errorbar(aes(ymin = lwr, ymax = upr), 
                  width = 0.2,
                  position = position_dodge(width = 0.5)) +
    facet_wrap(~ realm, nrow = 1, strip.position="bottom") +
    ylab(paste("Median climate connectivity (", "\U00B0","C)",sep="")) +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.text.y = element_text(size = text_size),
          strip.text = element_text(size = lab_size),
          legend.title = element_blank(),
          legend.text = element_text(size = lab_size),
          legend.position = c(0.1, 0.92), 
          legend.direction = "vertical",
          legend.key.size = unit(5, units = "mm"),
          legend.background = element_rect(fill="transparent"),
          legend.margin = margin(0,0,0,0),
          panel.spacing = unit(0, units = "cm"),
          panel.grid = element_blank()) +
    scale_y_continuous(breaks = seq(-4,4,0.5),
                       limits = c(-3,0.5)) +
    scale_colour_manual(values = cbpal1[c(3,1)]) +
    guides(color=guide_legend(override.aes=list(fill=NA)),
           fill = FALSE)

p2b <-
    ggplot(data = prop_fail_dat, 
           aes(x = year,
               y = prop_fail,
               colour = year)) +
    geom_point(position = position_dodge(width = 0.5)) +
    geom_errorbar(aes(ymin = lwr * 100, ymax = upr * 100), 
                  width = 0.2,
                  position = position_dodge(width = 0.5)) +
    geom_jitter(data = region_cc,
                alpha = 0.2,
                shape = 16,
                size= 1) +
    facet_wrap(~ realm, nrow = 1, strip.position="bottom") +
    ylab("Area unsuccessful connectivity (%)") +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = title_size),
          axis.text.y = element_text(size = text_size),
          strip.text = element_text(size = lab_size),
          legend.title = element_blank(),
          legend.text = element_text(size = 4),
          legend.position = "none", 
          legend.direction = "horizontal",
          panel.spacing = unit(0, units = "cm"),
          panel.grid = element_blank()) +
    scale_y_continuous(breaks = seq(-0,100,10)) +
    scale_colour_manual(values = cbpal1[c(3,1)])

p2 <-
    plot_grid(p2a, p2b, 
              nrow = 1, ncol = 2,
              align = "hv",
              labels = c("(a)", "(b)"), 
              label_size = lab_size)
p2

# ggsave(plot = p2, filename = "figs/cc_results.png", dpi = 800,
#        width = 16.6, height = 8, units = "cm")
```

In only 12 years, change in climate connectivity was widespread -- `r round((cc_decrease_area / total_ccc_area) * 100, 1)`% of cells forested in 2000 or 2012 (~ 3M km^2^) experienced loss of climate connectivity, compared to `r round((cc_increase_area / total_ccc_area) * 100, 1)`% of cells that experienced gains (\autoref{fig:fig-5-1}b). While average climate connectivity did not differ between years (`r median_cc_results$ref[median_cc_results$EV == "year"]`), the proportion of forested area that was unsuccessfully connected increased overall from 2000 to 2012 (`r prop_fail_results$ref[prop_fail_results$EV == "year"]`), with variation between realms (`r prop_fail_interaction$ref`). The biggest losses of climate connectivity were seen in Indomalaya (-`r filter(prop_fail_dat_yr, realm == "Indomalaya") %>% .[,"prop_fail_diff"]`%), followed by the Neotropics (-`r filter(prop_fail_dat_yr, realm == "Neotropics") %>% .[,"prop_fail_diff"]`%), Australasia (-`r filter(prop_fail_dat_yr, realm == "Australasia") %>% .[,"prop_fail_diff"]`%), and Oceania (-`r filter(prop_fail_dat_yr, realm == "Oceania") %>% .[,"prop_fail_diff"]`%).  Conversely, there was a considerable gain of connected forest area in the Afrotropical realm (+`r -(filter(prop_fail_dat_yr, realm == "Afrotropics") %>% .[,"prop_fail_diff"])`%), likely driven by apparent tree cover gain in the central Congo basin [@hansen_high-resolution_2013].

Loss of climate connectivity from 2000 to 2012 increased non-linearly with increasing area of forest loss (`r cc_loss_results[2, "ref"]`). Notably, the proportion of tropical forest area losing climate connectivity appeared to increase rapidly beyond 1,000 km^2^ of deforestation within a given land mass. The effect was clearest in Indomalaya and the Neotropics (\autoref{fig:fig-5-3}), probably because of the greater number of land masses experiencing such high levels of forest loss. A comparable effect is seen in the number and size of forest fragments created by forest loss [@taubert_global_2018]. We suggest that relatively low levels of forest loss reduce redundancy by removing links to future climate analogues, until a critical point is reached beyond which additional forest loss severs all links and climate connectivity falls below zero. Disproportionate benefits could come from reinstating these connections -- particularly along elevational gradients [cf. @elsen_global_2018] -- through forest restoration initiatives such as the Bonn Challenge, which aims to restore 3.5 million km^2^ by 2030. Habitat corridors are not appropriate for all taxa and locations [@early_analysis_2011; @lees_conservation_2008], but are likely to be of particular value in the locations where poor climate connectivity (\autoref{fig:fig-5-1}a) or high connectivity loss (\autoref{fig:fig-5-1}b) coincide with high species' vulnerability to climate change [\autoref{fig:fig-D-1}; @pacifici_framework_2018] or high levels of endemism (\autoref{fig:fig-D-2}).

(ref:cap-5-3) The proportion of total forested area in each land mass that lost climate connectivity between 2000 and 2012. Connectivity loss (% area) is plotted against increasing area of forest loss (log scale) and across different biogeographic realms (orange = Neotropics, blue = Afrotropics, green = Indomalaya, yellow = Australasia and pink = Oceania). Points correspond to raw data, with point size indicating the number of observations at that location. Fitted lines derive from model predictions with 95% confidence intervals.

```{r fig-5-3, fig.cap= "(ref:cap-5-3)", fig.width = 12/2.54, fig.height = 10/2.54}
ggplot(cc_loss_dat, 
       aes(x = tc_loss_log1p,
           y = prop_decrease_cc,
           colour = realm)) +
    geom_ribbon(aes(ymin = lwr,
                    ymax = upr,
                    fill = realm,
                    colour = NULL),
                alpha = 0.3) +
    geom_count(data = region_ccc,
               alpha = 0.5) +
    geom_line()+
    xlab(paste("Area of forest loss (km","\U00B2",")",sep="")) +
    ylab("Area losing connectivity (%)") +
    theme_bw() +
    theme(axis.text = element_text(size = text_size),
          axis.title = element_text(size = title_size),
          legend.direction = "horizontal", 
          legend.position = "top",
          legend.text = element_text(size = text_size),
          legend.box = "vertical",
          legend.spacing = unit(0, "cm"),
          legend.margin = margin(0,0,0,0,unit = "mm"),
          panel.grid = element_blank()) +
    scale_y_continuous(breaks = seq(0,100,10)) +
    scale_x_continuous(breaks = log1p(c(0, 10, 100, 1000, 10000, 100000)),
                       labels = c(0, 10, 100, "1,000", "10,000", "100,000")) +
    guides(colour = guide_legend(title = NULL,
                                 nrow=1,byrow=TRUE),
           fill = guide_legend(title = NULL,
                               nrow=1,byrow=TRUE),
           size = guide_legend(title = NULL, nrow = 1)) +
    scale_colour_manual(values = cbpal2) +
    scale_fill_manual(values = cbpal2)
```

The climate connectivity metric used here is a measure of the physical potential for thermally restricted groups of species to track climate through near-contiguous forest cover [cf. @mcguire_achieving_2016]. We focus on broad trends and patterns across the Earth's most biodiverse terrestrial region, which requires assumptions and simplifications that inevitably render our results less applicable at finer spatial scales and for particular species [@brito-morales_climate_2018]. We do not incorporate any species-specific information, but note that other factors will affect both the need and capacity for species to shift their ranges, such as *in situ* adaptation [@parmesan_ecological_2006; @hannah_fine-grain_2014; @socolar_phenological_2017] and dispersal limits [@schloss_dispersal_2012]. We assumed that forest patches of 10 km^2^ and above would be sufficiently large to facilitate species range shifts, but in reality minimum patch size will depend on the species of interest. Repeating our analyses with minimum patch sizes of 1, 5, 25 and 100 km^2^ revealed qualitatively similar results ([Appendix D.1](#text-D-1)).

Our estimates of climate connectivity are conservative because the forest cover layer does not distinguish between natural forest and tree plantations [@hansen_high-resolution_2013]. A precautionary reanalysis excluding tree plantations for the seven countries where plantation boundaries were available (Brazil, Cambodia, Colombia, Indonesia, Liberia, Malaysia, and Peru) revealed very similar results, except that from 2000 to 2012 the percentage of forest failing to connect to analogous climates decreased by `r -(signif(prop_fail_dat_som1$prop_fail[prop_fail_dat_som1$df_name == "With plantations" & prop_fail_dat_som1$year == "2012"] * 100, 3) - signif(prop_fail_dat_som1$prop_fail[prop_fail_dat_som1$df_name == "With plantations" & prop_fail_dat_som1$year == "2000"] * 100, 3))`% when including plantations, compared to an increase of `r signif(prop_fail_dat_som1$prop_fail[prop_fail_dat_som1$df_name == "Without plantations" & prop_fail_dat_som1$year == "2012"] * 100, 3) - signif(prop_fail_dat_som1$prop_fail[prop_fail_dat_som1$df_name == "Without plantations" & prop_fail_dat_som1$year == "2000"] * 100, 3)`% if they were excluded (see [Appendix D.2](#text-D-2)). We do not use sub-canopy temperature nor account for variation in forest quality, but note that thermal buffering by forest canopy varies little between pristine and degraded forests [@senior_tropical_2018]. Relative temperature change in the understorey, and thus our broad conclusions, should therefore be consistent across forest types.

We focus on the most severe climate warming scenario (RCP8.5), which appears the most likely outcome [@sanford_climate_2014]. Repeating our analysis for the least severe scenario (RCP2.6) resulted in similar overall trends, although we found that the proportion of successfully connected forest was enhanced and the loss of climate connectivity alleviated under this scenario ([Appendix D.3](#text-D-3)). Other climate variables -- particularly temperature extremes and precipitation -- are important in determining the climatic niche of any given species. Unfortunately, projections of future precipitation under climate change remain highly uncertain [@ipcc_climate_2013; @corlett_climate_2012] and are highly variable in space, both of which make it difficult to determine the gradient that species would have to follow to avoid deleterious changes in precipitation.

Our study is the first to quantify climate connectivity pantropically and over time. Loss of forest cover is extensive in the tropics [@hansen_high-resolution_2013; @lewis_increasing_2015] and causes widespread and accelerating fragmentation of remaining habitat [@taubert_global_2018]. Simultaneously, climate change poses an increasing risk to thermally-restricted forest specialists [@tewksbury_putting_2008]; the ability of these species to track climate will be important in determining their risk of extinction under climate change. We found that, across most of the tropics, current forest cover is already insufficient to facilitate range shifts to future climate analogues. Furthermore, the relationship between loss of forest cover and loss of climate connectivity is such that the problem is likely to magnify as forest loss continues. Landscape planning for climate resilience should endeavour to limit the extent of forest loss to protect existing forest cover, via land-sparing approaches and carbon-based payments for ecosystem services. Where opportunities arise to protect or restore forest, such as through the global landscape restoration agenda, disproportionate gains may come from focusing on connecting forest along climate gradients [@elsen_global_2018].

## Methods

We focused our study pantropically, including all land masses located between &plusmn;23.4&deg; latitude. For those land masses with a true extent beyond the tropics, boundaries were buffered by 100 km to reduce artificial truncation of climate gradients [cf. @mcguire_achieving_2016]. Maps were analysed at 1-km resolution projected into the World Cylindrical Equal Area projection. All spatial layers were processed with Python code implemented using the arcpy module in ArcMap version 10.4.1 [@esri_arcgis].

### Climate-partitioned forest patches

Since we were interested in climate connectivity for species inhabiting tropical forests, we calculated climate connectivity based on movement along a temperature gradient within forested areas only. We defined cells as forest or non-forest using tree cover data from @hansen_high-resolution_2013. For the year 2000, cells were defined as forested if they had > 50% tree cover [@hansen_high-resolution_2013]. Results are conservative because the @hansen_high-resolution_2013 dataset does not differentiate between natural forest and tree plantations, but see [Appendix D.2](#text-D-2) for analyses excluding cells within tree plantations for those countries (Brazil, Cambodia, Colombia, Indonesia, Liberia, Malaysia, and Peru) where plantation boundaries were available. For the year 2012, cells were classified based on forest loss and forest gain [@hansen_high-resolution_2013] relative to forest cover in 2000. If a cell had experienced forest loss from 2000 to 2012, it had gone from a forested to non-forested state and the cell was classed as non-forest in 2012. Conversely, if a cell had experienced forest gain from 2000 to 2012, it had gone from a non-forested to a forested state; providing there had been no concomitant loss, the cell was classed as forest in 2012. 

We partitioned forest patches using a present-day (~1950-2000), 30-arc-second global layer for Mean Annual Temperature (hereafter: temperature) from the WorldClim database [Version 1.4; @hijmans_very_2005; @mcguire_achieving_2016], re-sampled to 1 km^2^. The same approach was applied separately to forest cover in 2000 and 2012: temperature values were assigned to forested cells and reclassified to increments of 0.5&deg;C (full range: -18 to 32&deg;C), based on evidence that tropical species are sensitive to this degree of temperature difference [e.g. @freeman_rapid_2014; @raxworthy_extinction_2008]. The resulting raster was converted to polygons, whereby neighbouring forest cells with the same reclassified temperature value were assigned to the same polygon (hereafter: forest patch). While our approach is not specific to any particular taxon, it may be helpful to consider the method in the context of range shifts by non-volant terrestrial animals [cf. @nunez_connectivity_2013]. We removed forest patches < 10 km^2^, based on the assumption that they could not support a population for long enough to enable range shifts. See [Appendix D.1](#text-D-1) for the implications of varying minimum patch size. Patches within 2 km of each other were assigned to the same patch, conservatively assuming that populations could move across 2 km of non-forest to reach suitable habitat [cf. @mcguire_achieving_2016]. 

### Climate connectivity

The logic behind the measure of climate connectivity in @mcguire_achieving_2016 is that it represents the maximum temperature differential between current and future conditions that can be achieved by traversing a gradient from hotter to cooler patches within existing natural habitat. We assigned mean current and future temperature to all forest patches, again using data from WorldClim. Future temperature was for the year 2070 (average for 2061-2080), derived from the HadGEM2-AO general circulation model [@ipcc_climate_2013] and Representative Concentration Pathway (RCP) 8.5, which is the most severe ('business-as-usual') IPCC scenario. See [Appendix D.3](#text-D-3) for a re-analysis using RCP2.6, the least severe IPCC scenario. 

To trace each forest patch to its final destination, we identified which patches were neighbours, and iterated over all unique temperatures from cooler to hotter, each time identifying the patch corresponding to that temperature and the identity of its coolest neighbour. For patches with no cooler neighbours, the final destination patch is assigned as itself. For all other patches, the destination is assigned as the final destination of its coolest immediate neighbour. This algorithm ensures that the coolest destinations are passed on with each iteration, enabling destination patches to extend beyond immediate neighbours. See [Appendix D.4](#text-D-4) for a full worked example [@mcguire_achieving_2016].

Once each origin patch has a designated final destination patch, climate connectivity is calculated as the temperature difference between them. The key question is whether forest cover is sufficient for organisms to reach a place that, under future climate warming, is the same as or cooler than their current location. Thus, climate connectivity is the current temperature of the origin patch minus the future temperature of the destination patch. Where this value is zero or positive, the patch has achieved successful climate connectivity: there is sufficient structural connectivity between forested areas for organisms to reach forest that is same as or cooler than the temperatures they currently experience. Negative values indicate that the coolest reachable forest is still warmer under climate change than the current temperature, and inhabitant organisms would fail to reach an analogous climate under projected warming.

### Statistical analyses

All data were analysed in R [version 3.5.0; @r_core_team_2018]. The specific variables included are detailed below. For all models, statistical significance was inspected by dropping each fixed effect in turn and comparing to the full model [@zuur_mixed_2009]. The significance of main effects involved in an interaction was assessed in the same way, except reduced models were compared to a full model without the interaction term.

#### Current state of climate connectivity

Climate connectivity was necessarily calculated at a patch-level, but because patches themselves were not constant through time our spatial unit of replication was land mass. There were `r length(unique(region_cc$region))` land masses in total, comprising whole islands, such as Borneo and Madagascar, as well as sections of continents clipped to the extent of the tropics, such as for Africa and Australia. To assess current status we calculated median climate connectivity for each land mass, as well as the proportion of the total area of forested patches that failed to achieve successful climate connectivity (i.e. climate connectivity < 0). 

Median climate connectivity (range `r signif(min(region_cc$median_cc), 2)`-`r signif(max(region_cc$median_cc), 2)`&deg;C; n = `r length(unique(region_cc$region))`) and percentage area of unsuccessful connectivity (range `r signif(min(region_cc$prop_fail), 2)`-`r signif(max(region_cc$prop_fail), 2)`%; n = `r length(unique(region_cc$region))`) were modelled against year (categorical: 2000 or 2012) and biogeographic realm (categorical: Neotropics, Afrotropics, Indomalaya, Australasia, and Oceania), with an interaction between them and fit using the lme4 package [@bates_fitting_2015]. Median climate connectivity was modelled using a linear model. Area of successful connectivity was modelled as a binary variable (sum patch area with climate connectivity < 0 versus sum patch area with climate connectivity &ge; 0), using a Generalized Linear Model (GLM) with a quasi-binomial error distribution to account for overdispersion. For both response variables, model comparisons were performed using F tests.

#### Change in climate connectivity

Change of climate connectivity from 2000 to 2012 was first calculated at the level of the grid cell. For both years, we created a binary raster of climate connectivity, where cells were either successful (climate connectivity &ge; 0) or unsuccessful (climate connectivity < 0). Change was then calculated as climate connectivity in 2012 minus climate connectivity in 2000, and could take one of three values: no change (value of 0), loss of climate connectivity (value of -1), or gain of climate connectivity (value of 1). Where cells changed from a forested to a non-forested state, we assume a loss of climate connectivity for that cell. Where cells changed from a non-forested to a forested state (e.g. via secondary forest regrowth on abandoned farmland)[@aide_deforestation_2013], we assume a gain of climate connectivity for that cell. For analyses, loss of climate connectivity was captured for each land mass (n = `r length(unique(region_ccc$region))`) by the proportion of the total area of forested cells (forested in either 2000, 2012 or both) that experienced a change from successful to unsuccessful climate connectivity. An analogous approach was applied to quantify gain of climate connectivity.

Area of connectivity loss was modelled as a binary variable (area losing connectivity versus area not losing connectivity), against the explanatory variables: biogeographic realm and area of forest lost between 2000 and 2012. We used a Generalized Additive Model (GAM) implemented in the mgcv package [@wood_generalized_2017], with a quasi-binomial error distribution to account for overdispersion. 

### Code Availability

Custom Python code to calculate climate connectivity can be downloaded from GitHub (https://github.com/rasenior/ClimateConnectivity). These scripts have been directly adapted from the methods in @mcguire_achieving_2016, and the R code therein (https://github.com/JennyMcGuire/ClimateConnectivity).

### Data Availability

pantropical climate connectivity data that support the findings of this study have been deposited in The Environmental Information Data Centre (EIDC) and are accessible at [PENDING REF]. 

### Acknowledgements

We thank Jenny L. McGuire for making her code publicly available, and for providing us with additional help and guidance. We thank Michela Pacifici for providing maps of climate vulnerability, and BirdLife International for providing maps of Key Biodiversity Areas. Thanks also to Felix K. S. Lim, Philip J. Platts and Sarah A. Scriven for helpful discussions. R.A.S. was funded by a NERC studentship through the ACCE (Adapting to the Challenges of a Changing Environment) Doctoral Training Partnership (Grant No. NE/L002450/1).

